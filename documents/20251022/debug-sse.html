<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSE 调试页面</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .log { border: 1px solid #ccc; padding: 10px; height: 400px; overflow-y: auto; background: #f9f9f9; }
        .error { color: red; }
        .success { color: green; }
        .info { color: blue; }
        button { padding: 10px 20px; margin: 5px; }
    </style>
</head>
<body>
    <h1>SSE 流式调用调试</h1>
    
    <div>
        <button onclick="testSseStream()">测试 SSE 流式调用</button>
        <button onclick="clearLog()">清空日志</button>
    </div>
    
    <div id="log" class="log"></div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = type;
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        async function testSseStream() {
            log('开始测试 SSE 流式调用...', 'info');
            
            try {
                // 1. 测试创建流式调用
                log('步骤 1: 创建流式调用', 'info');
                const response = await fetch('/mcp/stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        jsonrpc: '2.0',
                        id: Date.now().toString(),
                        method: 'tools/call',
                        params: {
                            name: 'com.zkinfo.demo.service.UserService.getUserById',
                            arguments: { args: [1] },
                            stream: true
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                log(`创建流式调用成功: ${JSON.stringify(result)}`, 'success');

                if (result.streamId) {
                    // 2. 测试 SSE 连接
                    log('步骤 2: 建立 SSE 连接', 'info');
                    const eventSource = new EventSource(`/mcp/stream/${result.streamId}`);
                    
                    eventSource.onopen = function(event) {
                        log('SSE 连接已打开', 'success');
                    };
                    
                    eventSource.onmessage = function(event) {
                        log(`收到 SSE 数据: ${event.data}`, 'success');
                        
                        try {
                            const data = JSON.parse(event.data);
                            if (data.isLast) {
                                log('流式调用完成', 'success');
                                eventSource.close();
                            }
                        } catch (e) {
                            log(`解析数据失败: ${e.message}`, 'error');
                        }
                    };
                    
                    eventSource.onerror = function(event) {
                        log(`SSE 连接错误: ${JSON.stringify(event)}`, 'error');
                        eventSource.close();
                    };
                    
                    // 10秒后自动关闭
                    setTimeout(() => {
                        eventSource.close();
                        log('SSE 连接已关闭（超时）', 'info');
                    }, 10000);
                    
                } else {
                    log('创建流式调用失败：没有 streamId', 'error');
                }
                
            } catch (error) {
                log(`测试失败: ${error.message}`, 'error');
                console.error('详细错误:', error);
            }
        }

        // 页面加载时自动测试
        window.onload = function() {
            log('页面加载完成，准备测试', 'info');
        };
    </script>
</body>
</html>


