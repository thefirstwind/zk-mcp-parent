# ðŸ”§ SSEè¿žæŽ¥é”™è¯¯ä¿®å¤æ€»ç»“

## ðŸ› é—®é¢˜æè¿°

ç”¨æˆ·åœ¨æµè§ˆå™¨ä¸­ä½¿ç”¨SSEæµå¼è°ƒç”¨æ—¶ï¼Œè™½ç„¶èƒ½æ­£å¸¸æŽ¥æ”¶æ•°æ®ï¼Œä½†åœ¨æ•°æ®ä¼ è¾“å®ŒæˆåŽä¼šæ˜¾ç¤ºï¼š
```
âŒ é”™è¯¯: SSEè¿žæŽ¥é”™è¯¯æˆ–æ–­å¼€
```

## ðŸ” é—®é¢˜æ ¹å› 

SSEè¿žæŽ¥åœ¨æ­£å¸¸å®Œæˆæ•°æ®ä¼ è¾“åŽä¼šè‡ªåŠ¨å…³é—­ã€‚å½“æœåŠ¡å™¨å‘é€å®Œæ‰€æœ‰æ•°æ®å¹¶å…³é—­è¿žæŽ¥æ—¶ï¼Œæµè§ˆå™¨çš„EventSourceä¼šè§¦å‘`onerror`äº‹ä»¶ï¼ˆè¿™æ˜¯SSEè§„èŒƒçš„æ­£å¸¸è¡Œä¸ºï¼‰ã€‚

åŽŸä»£ç ä¸­çš„`onerror`å¤„ç†å™¨æ²¡æœ‰åŒºåˆ†"æ­£å¸¸å®Œæˆ"å’Œ"å¼‚å¸¸æ–­å¼€"ä¸¤ç§æƒ…å†µï¼Œå¯¼è‡´æ­£å¸¸å®Œæˆçš„è¿žæŽ¥ä¹Ÿè¢«æ˜¾ç¤ºä¸ºé”™è¯¯ã€‚

## âœ… ä¿®å¤æ–¹æ¡ˆ

### 1. æ·»åŠ çŠ¶æ€è·Ÿè¸ª

```javascript
let sseReceivedLastMessage = false; // è·Ÿè¸ªæ˜¯å¦å·²æ”¶åˆ°æœ€åŽä¸€æ¡æ¶ˆæ¯
```

### 2. åœ¨å¼€å§‹æ–°è¿žæŽ¥æ—¶é‡ç½®æ ‡å¿—

```javascript
async function startSseStream() {
    // é‡ç½®æ ‡å¿—
    sseReceivedLastMessage = false;
    // ...
}
```

### 3. æ”¶åˆ°æœ€åŽä¸€æ¡æ¶ˆæ¯æ—¶è®¾ç½®æ ‡å¿—

```javascript
currentEventSource.onmessage = function(event) {
    try {
        const data = JSON.parse(event.data);
        addStreamLog(logDiv, 'data', data);
        
        // å¦‚æžœæ˜¯æœ€åŽä¸€æ¡æ¶ˆæ¯ï¼Œè®¾ç½®æ ‡å¿—
        if (data.isLast) {
            sseReceivedLastMessage = true;
            setTimeout(() => stopSseStream(), 1000);
        }
    } catch (e) {
        addStreamLog(logDiv, 'error', `è§£æžæ•°æ®å¤±è´¥: ${e.message}`);
    }
};
```

### 4. æ”¹è¿›é”™è¯¯å¤„ç†é€»è¾‘

```javascript
currentEventSource.onerror = function(event) {
    // å¦‚æžœå·²ç»æ”¶åˆ°æœ€åŽä¸€æ¡æ¶ˆæ¯ï¼Œè¿™æ˜¯æ­£å¸¸å…³é—­
    if (sseReceivedLastMessage) {
        addStreamLog(logDiv, 'info', 'âœ… SSEæ•°æ®ä¼ è¾“å®Œæˆï¼Œè¿žæŽ¥å·²å…³é—­');
    } else if (currentEventSource.readyState === EventSource.CLOSED) {
        // è¿žæŽ¥å·²å…³é—­ä½†æ²¡æœ‰æ”¶åˆ°æœ€åŽä¸€æ¡æ¶ˆæ¯ï¼Œå¯èƒ½æ˜¯å¼‚å¸¸
        addStreamLog(logDiv, 'error', 'âš ï¸ SSEè¿žæŽ¥æ„å¤–å…³é—­ï¼ˆæœªæ”¶åˆ°å®Œæ•´æ•°æ®ï¼‰');
    } else {
        // å…¶ä»–é”™è¯¯æƒ…å†µ
        addStreamLog(logDiv, 'error', 'âŒ SSEè¿žæŽ¥é”™è¯¯æˆ–æ–­å¼€');
    }
    // ...
};
```

### 5. åœæ­¢è¿žæŽ¥æ—¶é‡ç½®æ ‡å¿—

```javascript
function stopSseStream() {
    if (currentEventSource) {
        currentEventSource.close();
        currentEventSource = null;
    }
    
    // é‡ç½®æ ‡å¿—
    sseReceivedLastMessage = false;
    // ...
}
```

## ðŸŽ¯ ä¿®å¤æ•ˆæžœ

ä¿®å¤åŽï¼Œç”¨æˆ·ç•Œé¢ä¼šæ˜¾ç¤ºæ›´å‹å¥½çš„æ¶ˆæ¯ï¼š

| åœºæ™¯ | ä¿®å¤å‰ | ä¿®å¤åŽ |
|------|--------|--------|
| æ­£å¸¸å®Œæˆ | âŒ é”™è¯¯: SSEè¿žæŽ¥é”™è¯¯æˆ–æ–­å¼€ | âœ… SSEæ•°æ®ä¼ è¾“å®Œæˆï¼Œè¿žæŽ¥å·²å…³é—­ |
| æ„å¤–æ–­å¼€ | âŒ é”™è¯¯: SSEè¿žæŽ¥é”™è¯¯æˆ–æ–­å¼€ | âš ï¸ SSEè¿žæŽ¥æ„å¤–å…³é—­ï¼ˆæœªæ”¶åˆ°å®Œæ•´æ•°æ®ï¼‰ |
| è¿žæŽ¥é”™è¯¯ | âŒ é”™è¯¯: SSEè¿žæŽ¥é”™è¯¯æˆ–æ–­å¼€ | âŒ SSEè¿žæŽ¥é”™è¯¯æˆ–æ–­å¼€ |

## ðŸ“ æµ‹è¯•æ­¥éª¤

### é‡è¦ï¼šæ¸…é™¤æµè§ˆå™¨ç¼“å­˜ï¼

åœ¨æµ‹è¯•ä¹‹å‰ï¼Œè¯·å…ˆæ¸…é™¤æµè§ˆå™¨ç¼“å­˜ä»¥èŽ·å–æœ€æ–°çš„HTMLæ–‡ä»¶ï¼š

**æ–¹æ³•1ï¼šç¡¬åˆ·æ–°ï¼ˆæŽ¨èï¼‰**
- Windows/Linux: `Ctrl + Shift + R` æˆ– `Ctrl + F5`
- macOS: `Cmd + Shift + R`

**æ–¹æ³•2ï¼šæ¸…é™¤ç¼“å­˜**
- Chrome: è®¾ç½® â†’ éšç§å’Œå®‰å…¨ â†’ æ¸…é™¤æµè§ˆæ•°æ®
- Firefox: é€‰é¡¹ â†’ éšç§ä¸Žå®‰å…¨ â†’ Cookieså’Œç½‘ç«™æ•°æ® â†’ æ¸…é™¤æ•°æ®
- Safari: åå¥½è®¾ç½® â†’ é«˜çº§ â†’ å¼€å‘ â†’ æ¸…ç©ºç¼“å­˜

**æ–¹æ³•3ï¼šä½¿ç”¨éšç§æ¨¡å¼**
- æ‰“å¼€éšç§/æ— ç—•æµè§ˆçª—å£ï¼ˆCtrl+Shift+N æˆ– Cmd+Shift+Nï¼‰
- è®¿é—® http://localhost:9091/mcp-client.html

### æµ‹è¯•æµç¨‹

1. **ç¡®ä¿æœåŠ¡æ­£åœ¨è¿è¡Œ**
   ```bash
   curl http://localhost:9091/mcp/health
   ```

2. **æ‰“å¼€MCPå®¢æˆ·ç«¯**
   ```
   http://localhost:9091/mcp-client.html
   ```

3. **åˆ‡æ¢åˆ°"SSEæµå¼è°ƒç”¨"æ ‡ç­¾**

4. **é€‰æ‹©ä¸€ä¸ªé¢„è®¾å‚æ•°**
   - ä¾‹å¦‚ï¼š"ðŸ‘¤ èŽ·å–ç”¨æˆ·ä¿¡æ¯ (getUserById)"

5. **ç‚¹å‡»"ðŸŒŠ å¼€å§‹æµå¼è°ƒç”¨"**

6. **è§‚å¯Ÿæ—¥å¿—è¾“å‡º**
   - åº”è¯¥çœ‹åˆ°ï¼š
     ```
     â„¹ï¸ æœåŠ¡å™¨å“åº”: {...}
     â„¹ï¸ SSEè¿žæŽ¥å·²å»ºç«‹
     ðŸ“¦ æ•°æ®: {"id":"stream_X","type":"data","data":{"message":"æ‰§è¡Œä¸­...","progress":50},...}
     ðŸ“¦ æ•°æ®: {"id":"stream_X","type":"data","data":{ç”¨æˆ·ä¿¡æ¯},...,"isLast":true}
     â„¹ï¸ âœ… SSEæ•°æ®ä¼ è¾“å®Œæˆï¼Œè¿žæŽ¥å·²å…³é—­
     â„¹ï¸ â¹ï¸ æµå¼è°ƒç”¨å·²åœæ­¢
     ```

7. **éªŒè¯æ²¡æœ‰é”™è¯¯æ¶ˆæ¯**
   - ä¸åº”è¯¥å†çœ‹åˆ°"âŒ é”™è¯¯: SSEè¿žæŽ¥é”™è¯¯æˆ–æ–­å¼€"

## ðŸ§ª å‘½ä»¤è¡Œæµ‹è¯•

å¦‚æžœæƒ³å¿«é€ŸéªŒè¯æœåŠ¡å™¨ç«¯åŠŸèƒ½ï¼Œå¯ä»¥è¿è¡Œï¼š

```bash
bash test-sse-from-browser.sh
```

åº”è¯¥çœ‹åˆ°ï¼š
```
æŽ¥æ”¶åˆ°çš„SSEæ•°æ®:
==================================
id:stream_X
event:data
data:{"id":"stream_X","type":"data","data":{"message":"æ‰§è¡Œä¸­...","progress":50},...,"isLast":false}

id:stream_X
event:data
data:{"id":"stream_X","type":"data","data":{å®Œæ•´çš„ç”¨æˆ·ä¿¡æ¯},...,"isLast":true}

âœ… æµ‹è¯•å®Œæˆ
```

## ðŸ“Š æŠ€æœ¯ç»†èŠ‚

### SSEäº‹ä»¶æµç¨‹

```
å®¢æˆ·ç«¯                                      æœåŠ¡å™¨
  |                                           |
  | new EventSource('/mcp/stream/XXX')        |
  |==========================================>|
  |                                           |
  | onopen                                    |
  |<------------------------------------------|
  |                                           |
  | onmessage (event: data, isLast: false)    |
  |<------------------------------------------|
  |                                           |
  | onmessage (event: data, isLast: true)     |
  | [è®¾ç½® sseReceivedLastMessage = true]       |
  |<------------------------------------------|
  |                                           |
  | æœåŠ¡å™¨å…³é—­è¿žæŽ¥                              |
  |                                           X
  |                                           
  | onerror (readyState = CLOSED)              
  | [æ£€æŸ¥ sseReceivedLastMessage]              
  | â†’ true: æ˜¾ç¤º"âœ… æ•°æ®ä¼ è¾“å®Œæˆ"                
  | â†’ false: æ˜¾ç¤º"âš ï¸ æ„å¤–å…³é—­"                  
  |                                           
```

### EventSource çŠ¶æ€

- `EventSource.CONNECTING (0)`: æ­£åœ¨è¿žæŽ¥
- `EventSource.OPEN (1)`: è¿žæŽ¥å·²å»ºç«‹
- `EventSource.CLOSED (2)`: è¿žæŽ¥å·²å…³é—­

å½“æœåŠ¡å™¨æ­£å¸¸å…³é—­SSEè¿žæŽ¥æ—¶ï¼š
1. `readyState` å˜ä¸º `EventSource.CLOSED`
2. è§¦å‘ `onerror` äº‹ä»¶ï¼ˆè¿™æ˜¯SSEè§„èŒƒçš„è¡Œä¸ºï¼‰
3. ä¸ä¼šè§¦å‘ `onclose` äº‹ä»¶ï¼ˆEventSource APIæ²¡æœ‰è¿™ä¸ªäº‹ä»¶ï¼‰

## ðŸ“š ç›¸å…³æ–‡ä»¶

- `/Users/shine/projects/zk-mcp-parent/zkInfo/src/main/resources/static/mcp-client.html` - ä¿®å¤çš„å‰ç«¯ä»£ç 
- `/Users/shine/projects/zk-mcp-parent/test-sse-from-browser.sh` - æµ‹è¯•è„šæœ¬
- `/Users/shine/projects/zk-mcp-parent/MCP-CLIENT-GUIDE.md` - ä½¿ç”¨æŒ‡å—

## âœ¨ æ€»ç»“

ä¿®å¤åŽçš„SSEè¿žæŽ¥çŽ°åœ¨èƒ½å¤Ÿï¼š
1. âœ… æ­£ç¡®åŒºåˆ†æ­£å¸¸å®Œæˆå’Œå¼‚å¸¸æ–­å¼€
2. âœ… æ˜¾ç¤ºå‹å¥½çš„çŠ¶æ€æ¶ˆæ¯
3. âœ… æä¾›æ¸…æ™°çš„ç”¨æˆ·åé¦ˆ
4. âœ… ç¬¦åˆSSEè§„èŒƒçš„è¡Œä¸º

---

ðŸ”§ ä¿®å¤æ—¥æœŸ: 2025-10-22  
ðŸ“ ä¿®å¤è€…: AI Assistant  
âœ… çŠ¶æ€: å·²å®Œæˆå¹¶æµ‹è¯•


