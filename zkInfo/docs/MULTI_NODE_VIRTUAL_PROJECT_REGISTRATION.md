# å¤šèŠ‚ç‚¹ zkInfo è™šæ‹Ÿé¡¹ç›®æ³¨å†Œæ–¹æ¡ˆ

## ğŸ“‹ é—®é¢˜æè¿°

åœ¨ zkInfo å¤šèŠ‚ç‚¹éƒ¨ç½²åœºæ™¯ä¸‹ï¼Œå½“å‰åœ¨æ·»åŠ è™šæ‹Ÿé¡¹ç›®æ—¶ï¼Œåªä¼šå°†æ‰§è¡Œæ¥å£çš„èŠ‚ç‚¹æ·»åŠ åˆ° Nacosï¼Œå¯¼è‡´å…¶ä»– zkInfo èŠ‚ç‚¹æ— æ³•æä¾›æœåŠ¡ã€‚éœ€è¦å°†æ‰€æœ‰æ´»è·ƒçš„ zkInfo èŠ‚ç‚¹éƒ½æ³¨å†Œåˆ° Nacosã€‚

## ğŸ¯ è§£å†³æ–¹æ¡ˆ

### 1. æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    zkInfo èŠ‚ç‚¹é›†ç¾¤                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Node 1 (192.168.1.1:9091)  â”‚  Node 2 (192.168.1.2:9091)  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ZkInfoSelfRegistration â”‚  â”‚  â”‚ ZkInfoSelfRegistration â”‚ â”‚
â”‚  â”‚ Service                â”‚  â”‚  â”‚ Service                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚              â”‚                â”‚              â”‚              â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                           â”‚                                  â”‚
â”‚                           â–¼                                  â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚                    â”‚    Nacos     â”‚                          â”‚
â”‚                    â”‚  (æœåŠ¡æ³¨å†Œ)   â”‚                          â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åˆ›å»ºè™šæ‹Ÿé¡¹ç›®æ—¶ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  VirtualProjectService.createVirtualProject()               â”‚
â”‚              â”‚                                               â”‚
â”‚              â–¼                                               â”‚
â”‚  VirtualProjectRegistrationService.registerVirtualProjectToNacos()
â”‚              â”‚                                               â”‚
â”‚              â–¼                                               â”‚
â”‚  NacosMcpRegistrationService.registerVirtualProjectAsMcp()
â”‚              â”‚                                               â”‚
â”‚              â–¼                                               â”‚
â”‚  registerInstancesToNacosForAllNodes()                       â”‚
â”‚              â”‚                                               â”‚
â”‚              â”œâ”€â”€â–º ZkInfoNodeDiscoveryService                 â”‚
â”‚              â”‚    .getAllActiveZkInfoNodes()                  â”‚
â”‚              â”‚    (ä» Nacos æŸ¥è¯¢æ‰€æœ‰æ´»è·ƒèŠ‚ç‚¹)                  â”‚
â”‚              â”‚                                               â”‚
â”‚              â–¼                                               â”‚
â”‚  ä¸ºæ¯ä¸ªèŠ‚ç‚¹æ³¨å†Œè™šæ‹Ÿé¡¹ç›®å®ä¾‹                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ Node 1       â”‚  â”‚ Node 2       â”‚  â”‚ Node 3       â”‚       â”‚
â”‚  â”‚ Instance     â”‚  â”‚ Instance     â”‚  â”‚ Instance     â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. æ ¸å¿ƒç»„ä»¶

#### 2.1 ZkInfoSelfRegistrationService
**åŠŸèƒ½**: zkInfo èŠ‚ç‚¹å¯åŠ¨æ—¶æ³¨å†Œè‡ªå·±åˆ° Nacos

**å®ç°**:
- ç›‘å¬ `ApplicationReadyEvent` äº‹ä»¶
- å°†å½“å‰èŠ‚ç‚¹æ³¨å†Œä¸º `zkinfo` æœåŠ¡åˆ° Nacos
- ä½¿ç”¨ä¸´æ—¶èŠ‚ç‚¹ï¼ˆ`ephemeral=true`ï¼‰ï¼ŒèŠ‚ç‚¹åœæ­¢åè‡ªåŠ¨åˆ é™¤

**å…³é”®ä»£ç **:
```java
@EventListener(ApplicationReadyEvent.class)
public void registerZkInfoNode() {
    Instance instance = new Instance();
    instance.setIp(localIp);
    instance.setPort(serverPort);
    instance.setEphemeral(true); // ä¸´æ—¶èŠ‚ç‚¹
    namingService.registerInstance(zkInfoServiceName, serviceGroup, instance);
}
```

#### 2.2 ZkInfoNodeDiscoveryService
**åŠŸèƒ½**: å‘ç°æ‰€æœ‰æ´»è·ƒçš„ zkInfo èŠ‚ç‚¹

**å®ç°**:
- ä» Nacos æŸ¥è¯¢ `zkinfo` æœåŠ¡çš„æ‰€æœ‰å®ä¾‹
- è¿‡æ»¤å‡ºå¥åº·çš„å®ä¾‹
- è¿”å›èŠ‚ç‚¹åˆ—è¡¨ï¼ˆIP:Portï¼‰

**å…³é”®ä»£ç **:
```java
public List<ZkInfoNode> getAllActiveZkInfoNodes() {
    List<Instance> instances = namingService.getAllInstances(zkInfoServiceName, serviceGroup);
    // è¿‡æ»¤å¥åº·çš„å®ä¾‹
    return healthyInstances.stream()
            .map(this::convertToZkInfoNode)
            .collect(Collectors.toList());
}
```

#### 2.3 NacosMcpRegistrationService å¢å¼º
**åŠŸèƒ½**: æ”¯æŒä¸ºæ‰€æœ‰æ´»è·ƒèŠ‚ç‚¹æ³¨å†Œè™šæ‹Ÿé¡¹ç›®å®ä¾‹

**æ–°å¢æ–¹æ³•**:
- `registerInstancesToNacosForAllNodes()`: ä¸ºæ‰€æœ‰æ´»è·ƒèŠ‚ç‚¹æ³¨å†Œå®ä¾‹
- `registerInstanceToNacosForNode()`: ä¸ºæŒ‡å®šèŠ‚ç‚¹æ³¨å†Œå®ä¾‹
- `buildInstanceMetadata()`: æ„å»ºå®ä¾‹å…ƒæ•°æ®ï¼ˆå¤ç”¨é€»è¾‘ï¼‰

**å…³é”®ä»£ç **:
```java
private void registerInstancesToNacosForAllNodes(...) {
    // 1. è·å–æ‰€æœ‰æ´»è·ƒèŠ‚ç‚¹
    List<ZkInfoNode> activeNodes = zkInfoNodeDiscoveryService.getAllActiveZkInfoNodes();
    
    // 2. ä¸ºæ¯ä¸ªèŠ‚ç‚¹æ³¨å†Œå®ä¾‹
    for (ZkInfoNode node : activeNodes) {
        registerInstanceToNacosForNode(..., node.getIp(), node.getPort());
    }
}
```

### 3. å·¥ä½œæµç¨‹

#### 3.1 èŠ‚ç‚¹å¯åŠ¨æµç¨‹
```
1. zkInfo èŠ‚ç‚¹å¯åŠ¨
2. ApplicationReadyEvent è§¦å‘
3. ZkInfoSelfRegistrationService.registerZkInfoNode()
   â”œâ”€â”€ æ£€æŸ¥å¹¶æ¸…ç†ä¸å¥åº·çš„è€èŠ‚ç‚¹
   â”‚   â”œâ”€â”€ æŸ¥è¯¢æ‰€æœ‰å·²å­˜åœ¨çš„ zkInfo èŠ‚ç‚¹
   â”‚   â”œâ”€â”€ æ£€æŸ¥æ¯ä¸ªèŠ‚ç‚¹çš„å¥åº·çŠ¶æ€
   â”‚   â””â”€â”€ å¯¹äºä¸å¥åº·çš„æŒä¹…èŠ‚ç‚¹ï¼Œåˆ é™¤åé‡æ–°æ³¨å†Œä¸ºä¸´æ—¶èŠ‚ç‚¹ï¼ˆè®© Nacos è‡ªåŠ¨æ‘˜é™¤ï¼‰
   â””â”€â”€ æ³¨å†Œå½“å‰èŠ‚ç‚¹åˆ° Nacos (æœåŠ¡å: zkinfo, ä¸´æ—¶èŠ‚ç‚¹)
```

#### 3.2 è™šæ‹Ÿé¡¹ç›®åˆ›å»ºæµç¨‹
```
1. è°ƒç”¨ POST /api/virtual-projects
2. VirtualProjectService.createVirtualProject()
3. VirtualProjectRegistrationService.registerVirtualProjectToNacos()
4. NacosMcpRegistrationService.registerVirtualProjectAsMcp()
5. registerInstancesToNacosForAllNodes()
   â”œâ”€â”€ æŸ¥è¯¢æ‰€æœ‰æ´»è·ƒçš„ zkInfo èŠ‚ç‚¹
   â””â”€â”€ ä¸ºæ¯ä¸ªèŠ‚ç‚¹æ³¨å†Œè™šæ‹Ÿé¡¹ç›®å®ä¾‹
```

### 4. é…ç½®è¯´æ˜

#### 4.1 application.yml
```yaml
spring:
  application:
    name: zkinfo  # zkInfo æœåŠ¡åç§°ï¼ˆç”¨äºèŠ‚ç‚¹å‘ç°ï¼‰

nacos:
  registry:
    enabled: true
    service-group: mcp-server  # æœåŠ¡ç»„
```

### 5. ä¼˜åŠ¿

1. **é«˜å¯ç”¨**: æ‰€æœ‰æ´»è·ƒèŠ‚ç‚¹éƒ½æ³¨å†Œï¼Œæ”¯æŒè´Ÿè½½å‡è¡¡å’Œæ•…éšœè½¬ç§»
2. **è‡ªåŠ¨å‘ç°**: é€šè¿‡ Nacos è‡ªåŠ¨å‘ç°æ‰€æœ‰æ´»è·ƒèŠ‚ç‚¹ï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®
3. **åŠ¨æ€æ›´æ–°**: èŠ‚ç‚¹ä¸Šçº¿/ä¸‹çº¿è‡ªåŠ¨æ›´æ–°ï¼Œæ— éœ€é‡å¯
4. **å‘åå…¼å®¹**: å¦‚æœèŠ‚ç‚¹å‘ç°å¤±è´¥ï¼Œä¼šå›é€€åˆ°åªæ³¨å†Œå½“å‰èŠ‚ç‚¹

### 6. ä¸å¥åº·èŠ‚ç‚¹æ¸…ç†æœºåˆ¶

#### 6.1 è‡ªåŠ¨æ¸…ç†é€»è¾‘
å½“æ–°èŠ‚ç‚¹å¯åŠ¨æ—¶ï¼Œä¼šè‡ªåŠ¨æ£€æŸ¥ Nacos ä¸Šå·²å­˜åœ¨çš„ zkInfo èŠ‚ç‚¹ï¼š

1. **æŸ¥è¯¢æ‰€æœ‰èŠ‚ç‚¹**: ä» Nacos æŸ¥è¯¢æ‰€æœ‰ `zkinfo` æœåŠ¡å®ä¾‹
2. **å¥åº·æ£€æŸ¥**: æ£€æŸ¥æ¯ä¸ªèŠ‚ç‚¹çš„ `healthy` å’Œ `enabled` çŠ¶æ€
3. **æ¸…ç†ä¸å¥åº·èŠ‚ç‚¹**:
   - **ä¸å¥åº·çš„æŒä¹…èŠ‚ç‚¹** (`ephemeral=false`): 
     - å…ˆåˆ é™¤æŒä¹…èŠ‚ç‚¹
     - é‡æ–°æ³¨å†Œä¸ºä¸´æ—¶èŠ‚ç‚¹ (`ephemeral=true`)
     - Nacos ä¼šè‡ªåŠ¨æ£€æµ‹å¿ƒè·³ï¼Œå¦‚æœæ²¡æœ‰å¿ƒè·³ä¼šè‡ªåŠ¨åˆ é™¤
   - **ä¸å¥åº·çš„ä¸´æ—¶èŠ‚ç‚¹** (`ephemeral=true`): 
     - Nacos ä¼šè‡ªåŠ¨æ‘˜é™¤ï¼Œåªè®°å½•æ—¥å¿—

#### 6.2 æ¸…ç†æµç¨‹
```
æ–°èŠ‚ç‚¹å¯åŠ¨
  â†“
æŸ¥è¯¢æ‰€æœ‰ zkInfo èŠ‚ç‚¹
  â†“
éå†æ¯ä¸ªèŠ‚ç‚¹
  â†“
æ£€æŸ¥å¥åº·çŠ¶æ€ (healthy && enabled)
  â†“
ä¸å¥åº· && æŒä¹…èŠ‚ç‚¹?
  â”œâ”€â”€ æ˜¯ â†’ åˆ é™¤æŒä¹…èŠ‚ç‚¹ â†’ é‡æ–°æ³¨å†Œä¸ºä¸´æ—¶èŠ‚ç‚¹ â†’ Nacos è‡ªåŠ¨æ‘˜é™¤
  â””â”€â”€ å¦ â†’ è·³è¿‡ï¼ˆä¸´æ—¶èŠ‚ç‚¹ç”± Nacos è‡ªåŠ¨ç®¡ç†ï¼‰
```

### 7. æ³¨æ„äº‹é¡¹

1. **èŠ‚ç‚¹æ³¨å†Œ**: ç¡®ä¿æ‰€æœ‰ zkInfo èŠ‚ç‚¹éƒ½æ³¨å†Œåˆ° Nacosï¼ˆé€šè¿‡ `ZkInfoSelfRegistrationService`ï¼‰
2. **æœåŠ¡ç»„**: ç¡®ä¿æ‰€æœ‰èŠ‚ç‚¹ä½¿ç”¨ç›¸åŒçš„æœåŠ¡ç»„ï¼ˆ`mcp-server`ï¼‰
3. **ç½‘ç»œè¿é€šæ€§**: ç¡®ä¿æ‰€æœ‰èŠ‚ç‚¹èƒ½å¤Ÿè®¿é—® Nacos æœåŠ¡å™¨
4. **æ•…éšœå¤„ç†**: å¦‚æœæŸä¸ªèŠ‚ç‚¹æ³¨å†Œå¤±è´¥ï¼Œä¼šè®°å½•é”™è¯¯ä½†ç»§ç»­å¤„ç†å…¶ä»–èŠ‚ç‚¹
5. **ä¸å¥åº·èŠ‚ç‚¹æ¸…ç†**: æ–°èŠ‚ç‚¹å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨æ¸…ç†ä¸å¥åº·çš„è€èŠ‚ç‚¹ï¼Œç¡®ä¿é›†ç¾¤å¥åº·

### 7. æµ‹è¯•éªŒè¯

1. **å¯åŠ¨å¤šä¸ª zkInfo èŠ‚ç‚¹**
   ```bash
   # èŠ‚ç‚¹1
   java -jar zkInfo.jar --server.port=9091
   
   # èŠ‚ç‚¹2
   java -jar zkInfo.jar --server.port=9092
   ```

2. **éªŒè¯èŠ‚ç‚¹æ³¨å†Œ**
   ```bash
   # æŸ¥è¯¢ Nacos ä¸­çš„ zkInfo èŠ‚ç‚¹
   curl http://nacos-server:8848/nacos/v1/ns/instance/list?serviceName=zkinfo&groupName=mcp-server
   ```

3. **åˆ›å»ºè™šæ‹Ÿé¡¹ç›®**
   ```bash
   curl -X POST http://node1:9091/api/virtual-projects \
     -H "Content-Type: application/json" \
     -d '{
       "endpointName": "test-endpoint",
       "projectName": "Test Project",
       "services": [...]
     }'
   ```

4. **éªŒè¯è™šæ‹Ÿé¡¹ç›®å®ä¾‹**
   ```bash
   # æŸ¥è¯¢è™šæ‹Ÿé¡¹ç›®çš„æ‰€æœ‰å®ä¾‹
   curl http://nacos-server:8848/nacos/v1/ns/instance/list?serviceName=virtual-test-endpoint&groupName=mcp-server
   ```

### 8. ç›¸å…³æ–‡ä»¶

- `ZkInfoSelfRegistrationService.java`: zkInfo èŠ‚ç‚¹è‡ªèº«æ³¨å†ŒæœåŠ¡
- `ZkInfoNodeDiscoveryService.java`: zkInfo èŠ‚ç‚¹å‘ç°æœåŠ¡
- `NacosMcpRegistrationService.java`: MCP æœåŠ¡æ³¨å†ŒæœåŠ¡ï¼ˆå·²å¢å¼ºï¼‰
- `VirtualProjectRegistrationService.java`: è™šæ‹Ÿé¡¹ç›®æ³¨å†ŒæœåŠ¡

