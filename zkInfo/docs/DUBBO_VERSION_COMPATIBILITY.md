# Dubbo ç‰ˆæœ¬å…¼å®¹æ€§ - å‚æ•°ç±»å‹è·å–ç­–ç•¥

## æ¦‚è¿°

æœ¬ç³»ç»Ÿæ”¯æŒ Dubbo 2.6ã€2.7 å’Œ 3.x ç‰ˆæœ¬ã€‚ç”±äº Dubbo 2.7 ä»¥ä¸‹ç‰ˆæœ¬ä¸æ”¯æŒ metadataï¼Œç³»ç»Ÿä¼šæ ¹æ® Dubbo ç‰ˆæœ¬è‡ªåŠ¨é€‰æ‹©æœ€åˆé€‚çš„å‚æ•°ç±»å‹è·å–ç­–ç•¥ã€‚

## ç‰ˆæœ¬æ£€æµ‹

ç³»ç»Ÿé€šè¿‡ä»¥ä¸‹æ–¹å¼æ£€æµ‹ Dubbo ç‰ˆæœ¬ï¼š

1. **ä» Provider çš„ parameters ä¸­è·å–**ï¼šæ£€æŸ¥ `dubbo` å‚æ•°å€¼
2. **ä»åè®®åˆ¤æ–­**ï¼šTriple åè®®è¡¨ç¤º Dubbo 3.x
3. **é»˜è®¤å€¼**ï¼šå¦‚æœæ— æ³•ç¡®å®šï¼Œé»˜è®¤å‡è®¾ä¸º Dubbo 2.x

### ç‰ˆæœ¬å­—ç¬¦ä¸²æ ¼å¼

- `3.x`ï¼šDubbo 3.x ç‰ˆæœ¬
- `2.7.x`ï¼šDubbo 2.7.x ç‰ˆæœ¬
- `2.6.x`ï¼šDubbo 2.6.x ç‰ˆæœ¬
- `2.x`ï¼šå…¶ä»– Dubbo 2.x ç‰ˆæœ¬ï¼ˆæ— æ³•ç¡®å®šå…·ä½“ç‰ˆæœ¬æ—¶ï¼‰

## å‚æ•°ç±»å‹è·å–ç­–ç•¥

### Dubbo 2.7+ ç‰ˆæœ¬ï¼ˆæ”¯æŒ metadataï¼‰

**ä¼˜å…ˆçº§é¡ºåºï¼š**

1. **ZooKeeper metadata**ï¼ˆæœ€å‡†ç¡®ï¼‰
   - ä¼˜å…ˆä½¿ç”¨æŒ‡å®šè·¯å¾„æ ¼å¼ï¼š`/dubbo/metadata/{interfaceName}/{version}/{group}/provider/{application}`
   - å›é€€åˆ° Dubbo SDK çš„ `MetadataReport`
   - å°è¯•å¤šç§è·¯å¾„æ ¼å¼

2. **æ•°æ®åº“è¯»å–**ï¼ˆfallbackï¼‰
   - å¦‚æœ metadata è·å–å¤±è´¥ï¼Œä»æ•°æ®åº“è¯»å–æ–¹æ³•ç­¾å
   - é€šè¿‡ `MethodSignatureResolver` è·å–å‚æ•°ç±»å‹ä¿¡æ¯

3. **ç±»å‹æ¨æ–­**ï¼ˆæœ€åæ‰‹æ®µï¼‰
   - å¦‚æœä»¥ä¸Šæ–¹å¼éƒ½å¤±è´¥ï¼Œä½¿ç”¨ç±»å‹æ¨æ–­é€»è¾‘

### Dubbo 2.7 ä»¥ä¸‹ç‰ˆæœ¬ï¼ˆä¸æ”¯æŒ metadataï¼‰

**ä¼˜å…ˆçº§é¡ºåºï¼š**

1. **æ•°æ®åº“è¯»å–**ï¼ˆä¸»è¦æ–¹å¼ï¼‰
   - ä¼˜å…ˆä»æ•°æ®åº“è¯»å–æ–¹æ³•ç­¾å
   - é€šè¿‡ `MethodSignatureResolver` è·å–å‚æ•°ç±»å‹ä¿¡æ¯
   - è¿™æ˜¯ Dubbo 2.7 ä»¥ä¸‹ç‰ˆæœ¬çš„ä¸»è¦æ•°æ®æº

2. **ZooKeeper metadata**ï¼ˆfallbackï¼Œä»¥é˜²ä¸‡ä¸€ï¼‰
   - æŸäº›ç‰¹æ®Šé…ç½®å¯èƒ½å¯ç”¨äº† metadata
   - å¦‚æœæ•°æ®åº“è¯»å–å¤±è´¥ï¼Œå°è¯• metadata

3. **ç±»å‹æ¨æ–­**ï¼ˆæœ€åæ‰‹æ®µï¼‰
   - å¦‚æœä»¥ä¸Šæ–¹å¼éƒ½å¤±è´¥ï¼Œä½¿ç”¨ç±»å‹æ¨æ–­é€»è¾‘

## æ•°æ®åº“è¡¨ç»“æ„

æ–¹æ³•ç­¾åä¿¡æ¯å­˜å‚¨åœ¨ä»¥ä¸‹æ•°æ®åº“è¡¨ä¸­ï¼š

### 1. `dubbo_service`
å­˜å‚¨ Dubbo æœåŠ¡ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼š
- `id`ï¼šæœåŠ¡ID
- `interface_name`ï¼šæ¥å£å…¨é™å®šå
- `version`ï¼šç‰ˆæœ¬å·
- `group`ï¼šåˆ†ç»„
- å…¶ä»–æœåŠ¡å…ƒæ•°æ®

### 2. `dubbo_service_method`
å­˜å‚¨æ–¹æ³•ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼š
- `id`ï¼šæ–¹æ³•ID
- `service_id`ï¼šå…³è”çš„æœåŠ¡ID
- `method_name`ï¼šæ–¹æ³•å
- `return_type`ï¼šè¿”å›ç±»å‹
- å…¶ä»–æ–¹æ³•å…ƒæ•°æ®

### 3. `dubbo_method_parameter`
å­˜å‚¨æ–¹æ³•å‚æ•°ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼š
- `id`ï¼šå‚æ•°ID
- `method_id`ï¼šå…³è”çš„æ–¹æ³•ID
- `parameter_name`ï¼šå‚æ•°å
- `parameter_type`ï¼šå‚æ•°ç±»å‹ï¼ˆå®Œæ•´ç±»åï¼‰
- `parameter_order`ï¼šå‚æ•°é¡ºåº
- `parameter_description`ï¼šå‚æ•°æè¿°

## ä½¿ç”¨æ–¹æ³•

### 1. ç¡®ä¿æ•°æ®åº“ä¸­æœ‰æ–¹æ³•ç­¾åæ•°æ®

ç³»ç»Ÿéœ€è¦ä»æ•°æ®åº“è¯»å–æ–¹æ³•ç­¾åï¼Œå› æ­¤éœ€è¦ç¡®ä¿ç›¸å…³æ•°æ®å·²ç»å…¥åº“ã€‚

æ•°æ®å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å…¥åº“ï¼š

- **è‡ªåŠ¨å…¥åº“**ï¼šç³»ç»Ÿåœ¨å‘ç° Dubbo æœåŠ¡æ—¶ï¼Œä¼šè‡ªåŠ¨è§£æå¹¶å…¥åº“ï¼ˆå¦‚æœ metadata å¯ç”¨ï¼‰
- **æ‰‹åŠ¨å…¥åº“**ï¼šé€šè¿‡ç®¡ç†æ¥å£æˆ–è„šæœ¬æ‰‹åŠ¨å¯¼å…¥æ–¹æ³•ç­¾åä¿¡æ¯

### 2. é…ç½® MethodSignatureResolver

`MethodSignatureResolver` å·²ç»è‡ªåŠ¨é…ç½®ï¼Œæ— éœ€é¢å¤–é…ç½®ã€‚å®ƒä½¿ç”¨ä»¥ä¸‹æœåŠ¡ï¼š

- `DubboServiceDbService`ï¼šæŸ¥è¯¢æœåŠ¡ä¿¡æ¯
- `DubboServiceMethodService`ï¼šæŸ¥è¯¢æ–¹æ³•å’Œå‚æ•°ä¿¡æ¯

### 3. æŸ¥çœ‹æ—¥å¿—

ç³»ç»Ÿä¼šè¾“å‡ºè¯¦ç»†çš„æ—¥å¿—ï¼Œæ˜¾ç¤ºå‚æ•°ç±»å‹è·å–çš„è¿‡ç¨‹ï¼š

```
ğŸ” å¼€å§‹è·å–å‚æ•°ç±»å‹: interface=com.example.Service, method=methodName, args.length=2, dubboVersion=2.6.x
   Dubbo ç‰ˆæœ¬ 2.6.x ä¸æ”¯æŒ metadata æ”¯æŒ
   ä½¿ç”¨æ•°æ®åº“ä¼˜å…ˆç­–ç•¥ï¼ˆé€‚ç”¨äº Dubbo 2.7 ä»¥ä¸‹ç‰ˆæœ¬ï¼‰
   ä»æ•°æ®åº“è¯»å–æ–¹æ³•ç­¾å: interface=com.example.Service, method=methodName
âœ… ä»æ•°æ®åº“è·å–åˆ°å‚æ•°ç±»å‹: java.lang.String, java.lang.Integer (ç±»å‹æ•°é‡: 2)
```

## ä»£ç ç¤ºä¾‹

### è·å–å‚æ•°ç±»å‹çš„æ ¸å¿ƒé€»è¾‘

```java
private String[] getParameterTypes(String interfaceName, String methodName, Object[] args, String dubboVersion) {
    // åˆ¤æ–­ Dubbo ç‰ˆæœ¬æ˜¯å¦æ”¯æŒ metadata
    boolean metadataSupported = isMetadataSupported(dubboVersion);
    
    if (metadataSupported) {
        // Dubbo 2.7+ï¼šä¼˜å…ˆ metadataï¼Œå¤±è´¥åˆ™æ•°æ®åº“
        return getParameterTypesWithMetadataFirst(interfaceName, methodName, args);
    } else {
        // Dubbo 2.7 ä»¥ä¸‹ï¼šä¼˜å…ˆæ•°æ®åº“ï¼Œå¤±è´¥åˆ™ metadataï¼ˆä»¥é˜²ä¸‡ä¸€ï¼‰
        return getParameterTypesWithDatabaseFirst(interfaceName, methodName, args);
    }
}
```

### ä»æ•°æ®åº“è·å–å‚æ•°ç±»å‹

```java
private String[] getParameterTypesFromDatabase(String interfaceName, String methodName, Object[] args) {
    MethodSignatureResolver.MethodSignature signature = 
            methodSignatureResolver.getMethodSignature(interfaceName, methodName);
    
    if (signature != null && signature.getParameters() != null) {
        int paramCount = signature.getParameters().size();
        String[] types = new String[paramCount];
        for (int i = 0; i < paramCount; i++) {
            types[i] = signature.getParameters().get(i).getType();
        }
        return types;
    }
    return null;
}
```

## å…¼å®¹æ€§è¯´æ˜

### ä¸ç°æœ‰é€»è¾‘çš„å…¼å®¹æ€§

1. **å‘åå…¼å®¹**ï¼šå¯¹äº Dubbo 2.7+ ç‰ˆæœ¬ï¼Œè¡Œä¸ºä¸ä¹‹å‰å®Œå…¨ä¸€è‡´ï¼ˆä¼˜å…ˆ metadataï¼‰
2. **è‡ªåŠ¨é€‚é…**ï¼šç³»ç»Ÿè‡ªåŠ¨æ£€æµ‹ç‰ˆæœ¬å¹¶é€‰æ‹©ç­–ç•¥ï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®
3. **é™çº§ç­–ç•¥**ï¼šå¦‚æœä¼˜å…ˆæ–¹å¼å¤±è´¥ï¼Œè‡ªåŠ¨é™çº§åˆ°å¤‡ç”¨æ–¹å¼

### æ€§èƒ½è€ƒè™‘

1. **ç¼“å­˜æœºåˆ¶**ï¼š`MethodSignatureResolver` ä½¿ç”¨å†…å­˜ç¼“å­˜ï¼Œé¿å…é‡å¤æŸ¥è¯¢æ•°æ®åº“
2. **æŒ‰éœ€åŠ è½½**ï¼šåªåœ¨éœ€è¦æ—¶æ‰æŸ¥è¯¢æ•°æ®åº“
3. **å¼‚å¸¸å¤„ç†**ï¼šæ•°æ®åº“æŸ¥è¯¢å¤±è´¥ä¸ä¼šå½±å“ç³»ç»Ÿè¿è¡Œï¼Œä¼šé™çº§åˆ°ç±»å‹æ¨æ–­

## æ•…éšœæ’æŸ¥

### é—®é¢˜ï¼šæ— æ³•ä»æ•°æ®åº“è·å–å‚æ•°ç±»å‹

**å¯èƒ½åŸå› ï¼š**
1. æ•°æ®åº“ä¸­ç¼ºå°‘æ–¹æ³•ç­¾åæ•°æ®
2. æ¥å£åæˆ–æ–¹æ³•åä¸åŒ¹é…
3. æ•°æ®åº“è¿æ¥é—®é¢˜

**è§£å†³æ–¹æ³•ï¼š**
1. æ£€æŸ¥æ•°æ®åº“ä¸­æ˜¯å¦æœ‰å¯¹åº”çš„æœåŠ¡å’Œæ–¹æ³•è®°å½•
2. æ£€æŸ¥æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯
3. ç¡®è®¤ `MethodSignatureResolver` å·²æ­£ç¡®æ³¨å…¥

### é—®é¢˜ï¼šå‚æ•°ç±»å‹æ•°é‡ä¸åŒ¹é…

**å¯èƒ½åŸå› ï¼š**
1. æ•°æ®åº“ä¸­çš„æ–¹æ³•ç­¾åä¸å®é™…æ–¹æ³•ä¸ä¸€è‡´
2. æ–¹æ³•é‡è½½å¯¼è‡´åŒ¹é…é”™è¯¯

**è§£å†³æ–¹æ³•ï¼š**
1. æ›´æ–°æ•°æ®åº“ä¸­çš„æ–¹æ³•ç­¾åä¿¡æ¯
2. æ£€æŸ¥æ˜¯å¦æœ‰æ–¹æ³•é‡è½½ï¼Œç¡®ä¿åŒ¹é…æ­£ç¡®çš„æ–¹æ³•

## æ€»ç»“

ç³»ç»Ÿé€šè¿‡ç‰ˆæœ¬æ£€æµ‹è‡ªåŠ¨é€‰æ‹©æœ€åˆé€‚çš„å‚æ•°ç±»å‹è·å–ç­–ç•¥ï¼š

- **Dubbo 2.7+**ï¼šä¼˜å…ˆä½¿ç”¨ metadataï¼ˆæœ€å‡†ç¡®ï¼‰ï¼Œå¤±è´¥åˆ™ä»æ•°æ®åº“è¯»å–
- **Dubbo 2.7 ä»¥ä¸‹**ï¼šä¼˜å…ˆä»æ•°æ®åº“è¯»å–ï¼ˆä¸»è¦æ–¹å¼ï¼‰ï¼Œå¤±è´¥åˆ™å°è¯• metadata

è¿™ç§è®¾è®¡ç¡®ä¿äº†ï¼š
- âœ… ä¸ç°æœ‰é€»è¾‘å®Œå…¨å…¼å®¹
- âœ… è‡ªåŠ¨é€‚é…ä¸åŒ Dubbo ç‰ˆæœ¬
- âœ… æä¾›å¯é çš„é™çº§ç­–ç•¥
- âœ… è¯¦ç»†çš„æ—¥å¿—è¾“å‡ºä¾¿äºæ’æŸ¥é—®é¢˜

