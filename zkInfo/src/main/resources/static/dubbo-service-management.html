<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DubboæœåŠ¡ç®¡ç†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .user-info {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 10px;
        }

        .user-info span {
            margin-right: 15px;
        }

        .tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 5px;
            margin-right: 10px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .tab:hover {
            background: #f0f0f0;
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .content-panel {
            display: none;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .content-panel.active {
            display: block;
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .search-box {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        input[type="text"], input[type="number"], textarea, select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-INIT {
            background: #e9ecef;
            color: #495057;
        }

        .status-PENDING {
            background: #fff3cd;
            color: #856404;
        }

        .status-APPROVED {
            background: #d4edda;
            color: #155724;
        }

        .status-REJECTED {
            background: #f8d7da;
            color: #721c24;
        }

        .status-OFFLINE {
            background: #6c757d;
            color: white;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            overflow: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #f0f0f0;
        }

        .alert {
            padding: 12px 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .method-parameters {
            margin-top: 20px;
        }

        .parameter-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
            background: #f8f9fa;
        }

        .parameter-item > div {
            flex: 1;
            margin-right: 10px;
        }

        .detail-view {
            padding: 20px;
        }

        .detail-row {
            display: flex;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .detail-label {
            font-weight: 600;
            width: 150px;
            color: #495057;
        }

        .detail-value {
            flex: 1;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”§ DubboæœåŠ¡ç®¡ç†</h1>
            <div class="user-info">
                <span>ç”¨æˆ·ID: <strong id="currentStaffId">-</strong></span>
                <span>è§’è‰²: <strong id="currentRole">-</strong></span>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" data-tab="services">æœåŠ¡åˆ—è¡¨</div>
            <div class="tab" data-tab="pending">å¾…å®¡æ‰¹</div>
            <div class="tab" data-tab="approved">å·²å®¡æ‰¹</div>
        </div>

        <!-- æœåŠ¡åˆ—è¡¨ -->
        <div id="services-panel" class="content-panel active">
            <div class="toolbar">
                <div class="search-box">
                    <input type="number" id="page-size" value="10" min="1" max="100" style="width: 80px;">
                    <span>æ¡/é¡µ</span>
                </div>
                <div>
                    <button class="btn btn-primary" id="refresh-services">åˆ·æ–°</button>
                </div>
            </div>

            <div id="services-alert"></div>
            <div id="services-table-container">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- å¾…å®¡æ‰¹åˆ—è¡¨ -->
        <div id="pending-panel" class="content-panel">
            <div class="toolbar">
                <div class="search-box">
                    <input type="number" id="pending-page-size" value="10" min="1" max="100" style="width: 80px;">
                    <span>æ¡/é¡µ</span>
                </div>
                <div>
                    <button class="btn btn-primary" id="refresh-pending">åˆ·æ–°</button>
                </div>
            </div>

            <div id="pending-alert"></div>
            <div id="pending-table-container">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- å·²å®¡æ‰¹åˆ—è¡¨ -->
        <div id="approved-panel" class="content-panel">
            <div class="toolbar">
                <div class="search-box">
                    <input type="number" id="approved-page-size" value="10" min="1" max="100" style="width: 80px;">
                    <span>æ¡/é¡µ</span>
                </div>
                <div>
                    <button class="btn btn-primary" id="refresh-approved">åˆ·æ–°</button>
                </div>
            </div>

            <div id="approved-alert"></div>
            <div id="approved-table-container">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>

    <!-- æœåŠ¡è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="service-detail-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">æœåŠ¡è¯¦æƒ…</div>
            <div id="service-detail-content"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('service-detail-modal')">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- å®¡æ‰¹æ¨¡æ€æ¡† -->
    <div id="approval-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">å®¡æ‰¹æœåŠ¡</div>
            <form id="approval-form">
                <input type="hidden" id="approval-service-id">
                <div class="form-group">
                    <label>å®¡æ‰¹æ„è§</label>
                    <textarea id="approval-comment" rows="4" placeholder="è¯·è¾“å…¥å®¡æ‰¹æ„è§ï¼ˆå¯é€‰ï¼‰"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('approval-modal')">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-danger" onclick="rejectService()">æ‹’ç»</button>
                    <button type="button" class="btn btn-success" onclick="approveService()">é€šè¿‡</button>
                </div>
            </form>
        </div>
    </div>

    <!-- å‚æ•°ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div id="parameter-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header" id="parameter-modal-title">æ–°å¢å‚æ•°</div>
            <form id="parameter-form">
                <input type="hidden" id="parameter-id">
                <input type="hidden" id="parameter-method-id">
                <div class="form-group">
                    <label>å‚æ•°å *</label>
                    <input type="text" id="parameter-name" required>
                </div>
                <div class="form-group">
                    <label>å‚æ•°ç±»å‹ *</label>
                    <input type="text" id="parameter-type" required>
                </div>
                <div class="form-group">
                    <label>å‚æ•°é¡ºåº *</label>
                    <input type="number" id="parameter-order" required min="0">
                </div>
                <div class="form-group">
                    <label>å‚æ•°æè¿°</label>
                    <textarea id="parameter-description" rows="3"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('parameter-modal')">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = '/api/dubbo-services';
        let currentUser = null;
        let currentPage = { services: 1, pending: 1, approved: 1 };
        let pageSize = { services: 10, pending: 10, approved: 10 };

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadCurrentUser();
            setupTabs();
            setupEventListeners();
            loadServices();
        });

        // åŠ è½½å½“å‰ç”¨æˆ·ä¿¡æ¯
        async function loadCurrentUser() {
            try {
                const response = await fetch(`${API_BASE}/current-user`);
                if (response.ok) {
                    currentUser = await response.json();
                    document.getElementById('currentStaffId').textContent = currentUser.staffId || '-';
                    document.getElementById('currentRole').textContent = currentUser.roleDescription || '-';
                } else {
                    showAlert('services-alert', 'æ— æ³•è·å–ç”¨æˆ·ä¿¡æ¯', 'error');
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                showAlert('services-alert', 'åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥', 'error');
            }
        }

        // æ£€æŸ¥æƒé™
        function hasPermission(permission) {
            if (!currentUser || !currentUser.permissions) return false;
            return currentUser.permissions[permission] === true;
        }

        // è®¾ç½®æ ‡ç­¾é¡µ
        function setupTabs() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    switchTab(tabName);
                });
            });
        }

        // å½“å‰æ ‡ç­¾é¡µ
        let currentTab = 'services';
        
        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            currentTab = tabName;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content-panel').forEach(p => p.classList.remove('active'));
            
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(`${tabName}-panel`).classList.add('active');
            
            if (tabName === 'services') {
                loadServices();
            } else if (tabName === 'pending') {
                loadPendingServices();
            } else if (tabName === 'approved') {
                loadApprovedServices();
            }
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬
        function setupEventListeners() {
            document.getElementById('refresh-services').addEventListener('click', function() {
                loadServices(currentPage.services);
            });
            document.getElementById('refresh-pending').addEventListener('click', function() {
                loadPendingServices(currentPage.pending);
            });
            document.getElementById('refresh-approved').addEventListener('click', function() {
                loadApprovedServices(currentPage.approved);
            });
            
            document.getElementById('parameter-form').addEventListener('submit', saveParameter);
        }

        // åŠ è½½æœåŠ¡åˆ—è¡¨
        async function loadServices(page = 1) {
            currentPage.services = page;
            const size = pageSize.services;
            const container = document.getElementById('services-table-container');
            container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                const response = await fetch(`${API_BASE}?page=${page}&size=${size}`);
                if (!response.ok) {
                    if (response.status === 403) {
                        container.innerHTML = '<div class="alert alert-error">æƒé™ä¸è¶³</div>';
                        return;
                    }
                    throw new Error('åŠ è½½å¤±è´¥');
                }
                
                const result = await response.json();
                renderServicesTable(result, container, 'services');
            } catch (error) {
                console.error('åŠ è½½æœåŠ¡åˆ—è¡¨å¤±è´¥:', error);
                container.innerHTML = '<div class="alert alert-error">åŠ è½½å¤±è´¥: ' + error.message + '</div>';
            }
        }

        // åŠ è½½å¾…å®¡æ‰¹æœåŠ¡
        async function loadPendingServices(page = 1) {
            currentPage.pending = page;
            const size = pageSize.pending;
            const container = document.getElementById('pending-table-container');
            container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                const response = await fetch(`${API_BASE}/pending?page=${page}&size=${size}`);
                if (!response.ok) {
                    if (response.status === 403) {
                        container.innerHTML = '<div class="alert alert-error">æƒé™ä¸è¶³</div>';
                        return;
                    }
                    throw new Error('åŠ è½½å¤±è´¥');
                }
                
                const result = await response.json();
                renderServicesTable(result, container, 'pending');
            } catch (error) {
                console.error('åŠ è½½å¾…å®¡æ‰¹æœåŠ¡å¤±è´¥:', error);
                container.innerHTML = '<div class="alert alert-error">åŠ è½½å¤±è´¥: ' + error.message + '</div>';
            }
        }

        // åŠ è½½å·²å®¡æ‰¹æœåŠ¡
        async function loadApprovedServices(page = 1) {
            currentPage.approved = page;
            const size = pageSize.approved;
            const container = document.getElementById('approved-table-container');
            container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                const response = await fetch(`${API_BASE}/approved?page=${page}&size=${size}`);
                if (!response.ok) {
                    if (response.status === 403) {
                        container.innerHTML = '<div class="alert alert-error">æƒé™ä¸è¶³</div>';
                        return;
                    }
                    throw new Error('åŠ è½½å¤±è´¥');
                }
                
                const result = await response.json();
                renderServicesTable(result, container, 'approved');
            } catch (error) {
                console.error('åŠ è½½å·²å®¡æ‰¹æœåŠ¡å¤±è´¥:', error);
                container.innerHTML = '<div class="alert alert-error">åŠ è½½å¤±è´¥: ' + error.message + '</div>';
            }
        }

        // æ¸²æŸ“æœåŠ¡è¡¨æ ¼
        function renderServicesTable(result, container, type) {
            if (!result.data || result.data.length === 0) {
                container.innerHTML = '<div class="empty-state">æš‚æ— æ•°æ®</div>';
                return;
            }

            let html = '<table><thead><tr>';
            html += '<th style="width: 30px;"></th><th>ID</th><th>æ¥å£å</th><th>åè®®</th><th>ç‰ˆæœ¬</th><th>åˆ†ç»„</th><th>åº”ç”¨</th>';
            html += '<th>çŠ¶æ€</th><th>Provideræ•°</th><th>åœ¨çº¿æ•°</th><th>å®¡æ‰¹äºº</th><th>å®¡æ‰¹æ—¶é—´</th><th>æ“ä½œ</th>';
            html += '</tr></thead><tbody>';

            result.data.forEach(service => {
                const status = service.approvalStatus || 'INIT';
                const statusText = {
                    'INIT': 'åˆå§‹åŒ–',
                    'PENDING': 'å¾…å®¡æ‰¹',
                    'APPROVED': 'å·²å®¡æ‰¹',
                    'REJECTED': 'å·²æ‹’ç»',
                    'OFFLINE': 'å·²ä¸‹çº¿'
                }[status] || status;

                html += '<tr class="service-row" data-service-id="' + service.id + '">';
                html += '<td><button class="btn-expand" onclick="toggleNodes(' + service.id + ', this)" style="background: none; border: none; cursor: pointer; font-size: 14px; padding: 4px;">â–¶</button></td>';
                html += `<td>${service.id}</td>`;
                html += `<td>${escapeHtml(service.interfaceName || '-')}</td>`;
                html += `<td>${escapeHtml(service.protocol || '-')}</td>`;
                html += `<td>${escapeHtml(service.version || '-')}</td>`;
                html += `<td>${escapeHtml(service.group || '-')}</td>`;
                html += `<td>${escapeHtml(service.application || '-')}</td>`;
                html += `<td><span class="status-badge status-${status}">${statusText}</span></td>`;
                html += `<td>${service.providerCount || 0}</td>`;
                html += `<td>${service.onlineProviderCount || 0}</td>`;
                html += `<td>${escapeHtml(service.approver || '-')}</td>`;
                html += `<td>${service.approvalTime ? formatDateTime(service.approvalTime) : '-'}</td>`;
                html += '<td>';
                html += `<button class="btn btn-secondary" onclick="viewServiceDetail(${service.id})" style="padding: 4px 8px; font-size: 12px;">è¯¦æƒ…</button> `;
                
                if (status === 'PENDING' && hasPermission('APPROVE_SERVICE')) {
                    html += `<button class="btn btn-warning" onclick="openApprovalModal(${service.id})" style="padding: 4px 8px; font-size: 12px;">å®¡æ‰¹</button> `;
                }
                
                // å·²å®¡æ‰¹çŠ¶æ€æ˜¾ç¤ºåŒæ­¥èŠ‚ç‚¹å’Œä¸‹çº¿æŒ‰é’®ï¼Œä¸æ˜¾ç¤ºæäº¤å®¡æ ¸æŒ‰é’®
                if (status === 'APPROVED') {
                    if (hasPermission('VIEW_SERVICE')) {
                        html += `<button class="btn btn-info" onclick="syncNodes(${service.id})" style="padding: 4px 8px; font-size: 12px;">åŒæ­¥èŠ‚ç‚¹</button> `;
                    }
                    if (hasPermission('APPROVE_SERVICE')) {
                        html += `<button class="btn btn-danger" onclick="offlineService(${service.id})" style="padding: 4px 8px; font-size: 12px;">ä¸‹çº¿</button> `;
                    }
                } else if (status === 'OFFLINE' && hasPermission('APPROVE_SERVICE')) {
                    // å·²ä¸‹çº¿çŠ¶æ€æ˜¾ç¤ºä¸Šçº¿æŒ‰é’®
                    html += `<button class="btn btn-success" onclick="onlineService(${service.id})" style="padding: 4px 8px; font-size: 12px;">ä¸Šçº¿</button> `;
                } else if (status !== 'PENDING' && status !== 'APPROVED' && status !== 'OFFLINE' && hasPermission('SUBMIT_FOR_REVIEW')) {
                    // éå¾…å®¡æ‰¹ã€éå·²å®¡æ‰¹ã€éå·²ä¸‹çº¿çŠ¶æ€æ‰æ˜¾ç¤ºæäº¤å®¡æ ¸æŒ‰é’®
                    html += `<button class="btn btn-primary" onclick="submitForReview(${service.id})" style="padding: 4px 8px; font-size: 12px;">æäº¤å®¡æ ¸</button> `;
                }
                
                html += '</td>';
                html += '</tr>';
                // èŠ‚ç‚¹åˆ—è¡¨è¡Œï¼ˆåˆå§‹éšè—ï¼‰
                html += '<tr class="nodes-row" id="nodes-row-' + service.id + '" style="display: none;">';
                html += '<td colspan="13"><div id="nodes-content-' + service.id + '" style="padding: 10px; background: #f8f9fa;">åŠ è½½ä¸­...</div></td>';
                html += '</tr>';
            });

            html += '</tbody></table>';

            // åˆ†é¡µ
            if (result.totalPages > 1) {
                html += '<div class="pagination">';
                html += `<button class="btn btn-secondary" ${result.currentPage <= 1 ? 'disabled' : ''} onclick="load${type.charAt(0).toUpperCase() + type.slice(1)}Services(${result.currentPage - 1})">ä¸Šä¸€é¡µ</button>`;
                html += `<span>ç¬¬ ${result.currentPage} / ${result.totalPages} é¡µ (å…± ${result.totalElements} æ¡)</span>`;
                html += `<button class="btn btn-secondary" ${result.currentPage >= result.totalPages ? 'disabled' : ''} onclick="load${type.charAt(0).toUpperCase() + type.slice(1)}Services(${result.currentPage + 1})">ä¸‹ä¸€é¡µ</button>`;
                html += '</div>';
            }

            container.innerHTML = html;
        }

        // æŸ¥çœ‹æœåŠ¡è¯¦æƒ…
        async function viewServiceDetail(serviceId) {
            try {
                const response = await fetch(`${API_BASE}/${serviceId}`);
                if (!response.ok) {
                    if (response.status === 403) {
                        alert('æƒé™ä¸è¶³');
                        return;
                    }
                    throw new Error('åŠ è½½å¤±è´¥');
                }
                
                const service = await response.json();
                renderServiceDetail(service);
                openModal('service-detail-modal');
            } catch (error) {
                console.error('åŠ è½½æœåŠ¡è¯¦æƒ…å¤±è´¥:', error);
                alert('åŠ è½½å¤±è´¥: ' + error.message);
            }
        }

        // æ¸²æŸ“æœåŠ¡è¯¦æƒ…
        async function renderServiceDetail(service) {
            const container = document.getElementById('service-detail-content');
            
            // ä¿å­˜serviceIdåˆ°å…¨å±€å˜é‡ä»¥ä¾¿åç»­æ“ä½œä½¿ç”¨
            window.currentServiceId = service.id;
            
            let html = `<div class="detail-view" data-service-id="${service.id}">`;
            html += '<div class="detail-row"><div class="detail-label">ID:</div><div class="detail-value">' + service.id + '</div></div>';
            html += '<div class="detail-row"><div class="detail-label">æ¥å£å:</div><div class="detail-value">' + escapeHtml(service.interfaceName || '-') + '</div></div>';
            html += '<div class="detail-row"><div class="detail-label">åè®®:</div><div class="detail-value">' + escapeHtml(service.protocol || '-') + '</div></div>';
            html += '<div class="detail-row"><div class="detail-label">ç‰ˆæœ¬:</div><div class="detail-value">' + escapeHtml(service.version || '-') + '</div></div>';
            html += '<div class="detail-row"><div class="detail-label">åˆ†ç»„:</div><div class="detail-value">' + escapeHtml(service.group || '-') + '</div></div>';
            html += '<div class="detail-row"><div class="detail-label">åº”ç”¨:</div><div class="detail-value">' + escapeHtml(service.application || '-') + '</div></div>';
            html += '<div class="detail-row"><div class="detail-label">çŠ¶æ€:</div><div class="detail-value">' + (service.approvalStatus || 'INIT') + '</div></div>';
            html += '<div class="detail-row"><div class="detail-label">Provideræ•°:</div><div class="detail-value">' + (service.providerCount || 0) + '</div></div>';
            html += '<div class="detail-row"><div class="detail-label">åœ¨çº¿æ•°:</div><div class="detail-value">' + (service.onlineProviderCount || 0) + '</div></div>';
            html += '<div class="detail-row"><div class="detail-label">å®¡æ‰¹äºº:</div><div class="detail-value">' + escapeHtml(service.approver || '-') + '</div></div>';
            html += '<div class="detail-row"><div class="detail-label">å®¡æ‰¹æ—¶é—´:</div><div class="detail-value">' + (service.approvalTime ? formatDateTime(service.approvalTime) : '-') + '</div></div>';
            html += '<div class="detail-row"><div class="detail-label">å®¡æ‰¹æ„è§:</div><div class="detail-value">' + escapeHtml(service.approvalComment || '-') + '</div></div>';
            html += '<div class="detail-row"><div class="detail-label">åˆ›å»ºæ—¶é—´:</div><div class="detail-value">' + (service.createdAt ? formatDateTime(service.createdAt) : '-') + '</div></div>';
            html += '<div class="detail-row"><div class="detail-label">æ›´æ–°æ—¶é—´:</div><div class="detail-value">' + (service.updatedAt ? formatDateTime(service.updatedAt) : '-') + '</div></div>';
            
            // åŠ è½½æ–¹æ³•åˆ—è¡¨
            try {
                const methodsResponse = await fetch(`${API_BASE}/${service.id}/methods`);
                if (methodsResponse.ok) {
                    const methods = await methodsResponse.json();
                    html += '<div class="detail-row"><div class="detail-label">æ–¹æ³•åˆ—è¡¨:</div><div class="detail-value">';
                    if (methods && methods.length > 0) {
                        html += '<div class="method-parameters">';
                        for (const method of methods) {
                            html += `<div style="margin-bottom: 15px; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">`;
                            html += `<strong>${escapeHtml(method.methodName)}</strong> â†’ ${escapeHtml(method.returnType || 'void')}`;
                            
                            // åŠ è½½å‚æ•°åˆ—è¡¨
                            try {
                                const paramsResponse = await fetch(`${API_BASE}/methods/${method.id}/parameters`);
                                if (paramsResponse.ok) {
                                    const parameters = await paramsResponse.json();
                                    if (parameters && parameters.length > 0) {
                                        html += '<div style="margin-top: 10px;">';
                                        html += '<table style="width: 100%; font-size: 12px;"><thead><tr><th>é¡ºåº</th><th>å‚æ•°å</th><th>ç±»å‹</th><th>æè¿°</th><th>æ“ä½œ</th></tr></thead><tbody>';
                                        parameters.forEach(param => {
                                            html += '<tr>';
                                            html += `<td>${param.parameterOrder}</td>`;
                                            html += `<td>${escapeHtml(param.parameterName)}</td>`;
                                            html += `<td>${escapeHtml(param.parameterType)}</td>`;
                                            html += `<td>${escapeHtml(param.parameterDescription || '-')}</td>`;
                                            html += '<td>';
                                            if (hasPermission('UPDATE_PARAMETER')) {
                                                html += `<button class="btn btn-secondary" onclick="editParameter(${param.id}, ${method.id})" style="padding: 2px 6px; font-size: 11px;">ç¼–è¾‘</button> `;
                                            }
                                            if (hasPermission('DELETE_PARAMETER')) {
                                                html += `<button class="btn btn-danger" onclick="deleteParameter(${param.id})" style="padding: 2px 6px; font-size: 11px;">åˆ é™¤</button>`;
                                            }
                                            html += '</td>';
                                            html += '</tr>';
                                        });
                                        html += '</tbody></table>';
                                        html += '</div>';
                                    }
                                }
                            } catch (e) {
                                console.error('åŠ è½½å‚æ•°å¤±è´¥:', e);
                            }
                            
                            if (hasPermission('CREATE_PARAMETER')) {
                                html += `<button class="btn btn-primary" onclick="addParameter(${method.id})" style="margin-top: 5px; padding: 4px 8px; font-size: 11px;">æ·»åŠ å‚æ•°</button>`;
                            }
                            
                            html += '</div>';
                        }
                        html += '</div>';
                    } else {
                        html += 'æš‚æ— æ–¹æ³•';
                    }
                    html += '</div></div>';
                }
            } catch (e) {
                console.error('åŠ è½½æ–¹æ³•åˆ—è¡¨å¤±è´¥:', e);
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        // æ‰“å¼€å®¡æ‰¹æ¨¡æ€æ¡†
        function openApprovalModal(serviceId) {
            document.getElementById('approval-service-id').value = serviceId;
            document.getElementById('approval-comment').value = '';
            openModal('approval-modal');
        }

        // å®¡æ‰¹æœåŠ¡
        async function approveService() {
            const serviceId = document.getElementById('approval-service-id').value;
            const comment = document.getElementById('approval-comment').value;
            const approver = currentUser ? currentUser.staffId : '';

            try {
                const url = `${API_BASE}/${serviceId}/approve?approver=${encodeURIComponent(approver)}${comment ? '&comment=' + encodeURIComponent(comment) : ''}`;
                const response = await fetch(url, { method: 'POST' });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'å®¡æ‰¹å¤±è´¥');
                }
                
                alert('å®¡æ‰¹æˆåŠŸ');
                closeModal('approval-modal');
                // é‡æ–°åŠ è½½å½“å‰æ ‡ç­¾é¡µ
                if (currentTab === 'pending') {
                    loadPendingServices(currentPage.pending);
                } else if (currentTab === 'approved') {
                    loadApprovedServices(currentPage.approved);
                } else {
                    loadServices(currentPage.services);
                }
            } catch (error) {
                console.error('å®¡æ‰¹å¤±è´¥:', error);
                alert('å®¡æ‰¹å¤±è´¥: ' + error.message);
            }
        }

        // æ‹’ç»æœåŠ¡
        async function rejectService() {
            const serviceId = document.getElementById('approval-service-id').value;
            const comment = document.getElementById('approval-comment').value;
            const approver = currentUser ? currentUser.staffId : '';

            try {
                const url = `${API_BASE}/${serviceId}/reject?approver=${encodeURIComponent(approver)}${comment ? '&comment=' + encodeURIComponent(comment) : ''}`;
                const response = await fetch(url, { method: 'POST' });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'æ‹’ç»å¤±è´¥');
                }
                
                alert('æ‹’ç»æˆåŠŸ');
                closeModal('approval-modal');
                // é‡æ–°åŠ è½½å½“å‰æ ‡ç­¾é¡µ
                if (currentTab === 'pending') {
                    loadPendingServices(currentPage.pending);
                } else if (currentTab === 'approved') {
                    loadApprovedServices(currentPage.approved);
                } else {
                    loadServices(currentPage.services);
                }
            } catch (error) {
                console.error('æ‹’ç»å¤±è´¥:', error);
                alert('æ‹’ç»å¤±è´¥: ' + error.message);
            }
        }

        // æäº¤å®¡æ ¸
        async function submitForReview(serviceId) {
            if (!confirm('ç¡®è®¤æäº¤å®¡æ ¸ï¼Ÿ')) return;
            
            const submitter = currentUser ? currentUser.staffId : '';

            try {
                const url = `${API_BASE}/${serviceId}/submit-for-review?submitter=${encodeURIComponent(submitter)}`;
                const response = await fetch(url, { method: 'POST' });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'æäº¤å¤±è´¥');
                }
                
                alert('æäº¤æˆåŠŸ');
                // é‡æ–°åŠ è½½å½“å‰æ ‡ç­¾é¡µ
                if (currentTab === 'pending') {
                    loadPendingServices(currentPage.pending);
                } else if (currentTab === 'approved') {
                    loadApprovedServices(currentPage.approved);
                } else {
                    loadServices(currentPage.services);
                }
            } catch (error) {
                console.error('æäº¤å¤±è´¥:', error);
                alert('æäº¤å¤±è´¥: ' + error.message);
            }
        }

        // åŒæ­¥èŠ‚ç‚¹
        async function syncNodes(serviceId) {
            if (!confirm('ç¡®è®¤åŒæ­¥èŠ‚ç‚¹ï¼Ÿè¿™å°†é‡æ–°åŒæ­¥è¯¥æœåŠ¡çš„èŠ‚ç‚¹ä¿¡æ¯ã€‚')) return;

            try {
                const url = `${API_BASE}/${serviceId}/sync-nodes`;
                const response = await fetch(url, { method: 'POST' });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'åŒæ­¥å¤±è´¥');
                }
                
                const result = await response.text();
                alert(result || 'åŒæ­¥æˆåŠŸ');
                // é‡æ–°åŠ è½½å½“å‰æ ‡ç­¾é¡µ
                if (currentTab === 'approved') {
                    loadApprovedServices(currentPage.approved);
                } else if (currentTab === 'pending') {
                    loadPendingServices(currentPage.pending);
                } else {
                    loadServices(currentPage.services);
                }
            } catch (error) {
                console.error('åŒæ­¥èŠ‚ç‚¹å¤±è´¥:', error);
                alert('åŒæ­¥å¤±è´¥: ' + error.message);
            }
        }

        // ä¸‹çº¿æœåŠ¡
        async function offlineService(serviceId) {
            if (!confirm('ç¡®è®¤ä¸‹çº¿è¯¥æœåŠ¡ï¼Ÿä¸‹çº¿åå°†æ³¨é”€å¯¹åº”çš„MCPæœåŠ¡ï¼Œä¸”æœåŠ¡çŠ¶æ€å°†å˜ä¸ºå·²ä¸‹çº¿ã€‚')) return;

            try {
                const url = `${API_BASE}/${serviceId}/offline`;
                const response = await fetch(url, { method: 'POST' });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'ä¸‹çº¿å¤±è´¥');
                }
                
                const result = await response.text();
                alert(result || 'æœåŠ¡å·²ä¸‹çº¿');
                // é‡æ–°åŠ è½½å½“å‰æ ‡ç­¾é¡µ
                if (currentTab === 'approved') {
                    loadApprovedServices(currentPage.approved);
                } else if (currentTab === 'pending') {
                    loadPendingServices(currentPage.pending);
                } else {
                    loadServices(currentPage.services);
                }
            } catch (error) {
                console.error('ä¸‹çº¿æœåŠ¡å¤±è´¥:', error);
                alert('ä¸‹çº¿å¤±è´¥: ' + error.message);
            }
        }

        // ä¸Šçº¿æœåŠ¡
        async function onlineService(serviceId) {
            if (!confirm('ç¡®è®¤ä¸Šçº¿è¯¥æœåŠ¡ï¼Ÿä¸Šçº¿åå°†æ¢å¤ä¸ºå·²å®¡æ‰¹çŠ¶æ€ï¼Œå¹¶é‡æ–°æ³¨å†Œåˆ°MCPã€‚')) return;

            try {
                const url = `${API_BASE}/${serviceId}/online`;
                const response = await fetch(url, { method: 'POST' });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'ä¸Šçº¿å¤±è´¥');
                }
                
                const result = await response.text();
                alert(result || 'æœåŠ¡å·²ä¸Šçº¿');
                // é‡æ–°åŠ è½½å½“å‰æ ‡ç­¾é¡µ
                if (currentTab === 'approved') {
                    loadApprovedServices(currentPage.approved);
                } else if (currentTab === 'pending') {
                    loadPendingServices(currentPage.pending);
                } else {
                    loadServices(currentPage.services);
                }
            } catch (error) {
                console.error('ä¸Šçº¿æœåŠ¡å¤±è´¥:', error);
                alert('ä¸Šçº¿å¤±è´¥: ' + error.message);
            }
        }

        // åˆ‡æ¢èŠ‚ç‚¹åˆ—è¡¨æ˜¾ç¤º/éšè—
        async function toggleNodes(serviceId, button) {
            const nodesRow = document.getElementById('nodes-row-' + serviceId);
            const nodesContent = document.getElementById('nodes-content-' + serviceId);
            
            if (nodesRow.style.display === 'none') {
                // å±•å¼€ï¼šåŠ è½½èŠ‚ç‚¹åˆ—è¡¨
                nodesRow.style.display = 'table-row';
                button.textContent = 'â–¼';
                
                // å¦‚æœè¿˜æ²¡æœ‰åŠ è½½è¿‡èŠ‚ç‚¹æ•°æ®ï¼Œåˆ™åŠ è½½
                if (nodesContent.textContent === 'åŠ è½½ä¸­...' || nodesContent.dataset.loaded !== 'true') {
                    await loadNodes(serviceId);
                    nodesContent.dataset.loaded = 'true';
                }
            } else {
                // æŠ˜å ï¼šéšè—èŠ‚ç‚¹åˆ—è¡¨
                nodesRow.style.display = 'none';
                button.textContent = 'â–¶';
            }
        }

        // åŠ è½½èŠ‚ç‚¹åˆ—è¡¨
        async function loadNodes(serviceId) {
            const nodesContent = document.getElementById('nodes-content-' + serviceId);
            nodesContent.innerHTML = '<div style="text-align: center; padding: 20px;">åŠ è½½ä¸­...</div>';

            try {
                const response = await fetch(`${API_BASE}/${serviceId}/nodes`);
                if (!response.ok) {
                    throw new Error('åŠ è½½èŠ‚ç‚¹åˆ—è¡¨å¤±è´¥');
                }
                
                const nodes = await response.json();
                
                if (!nodes || nodes.length === 0) {
                    nodesContent.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">æš‚æ— èŠ‚ç‚¹ä¿¡æ¯</div>';
                    return;
                }
                
                let html = '<div style="margin-left: 20px;"><h4 style="margin-bottom: 10px;">èŠ‚ç‚¹åˆ—è¡¨ (' + nodes.length + ' ä¸ª)</h4>';
                html += '<table style="width: 100%; border-collapse: collapse; background: white; border-radius: 4px;">';
                html += '<thead><tr style="background: #e9ecef;">';
                html += '<th style="padding: 8px; text-align: left; border-bottom: 1px solid #dee2e6;">ID</th>';
                html += '<th style="padding: 8px; text-align: left; border-bottom: 1px solid #dee2e6;">åœ°å€</th>';
                html += '<th style="padding: 8px; text-align: left; border-bottom: 1px solid #dee2e6;">ZooKeeperè·¯å¾„</th>';
                html += '<th style="padding: 8px; text-align: left; border-bottom: 1px solid #dee2e6;">æœ€ååŒæ­¥</th>';
                html += '</tr></thead><tbody>';
                
                nodes.forEach(node => {
                    html += '<tr style="border-bottom: 1px solid #f0f0f0;">';
                    html += `<td style="padding: 8px;">${node.id || '-'}</td>`;
                    html += `<td style="padding: 8px;">${escapeHtml(node.address || '-')}</td>`;
                    html += `<td style="padding: 8px; word-break: break-all; max-width: 400px; font-size: 12px;">${escapeHtml(node.zkPath || '-')}</td>`;
                    html += `<td style="padding: 8px;">${node.lastSyncTime ? formatDateTime(node.lastSyncTime) : '-'}</td>`;
                    html += '</tr>';
                });
                
                html += '</tbody></table></div>';
                nodesContent.innerHTML = html;
                
            } catch (error) {
                console.error('åŠ è½½èŠ‚ç‚¹åˆ—è¡¨å¤±è´¥:', error);
                nodesContent.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">åŠ è½½å¤±è´¥: ' + error.message + '</div>';
            }
        }

        // æ·»åŠ å‚æ•°
        function addParameter(methodId) {
            document.getElementById('parameter-modal-title').textContent = 'æ–°å¢å‚æ•°';
            document.getElementById('parameter-id').value = '';
            document.getElementById('parameter-method-id').value = methodId;
            document.getElementById('parameter-name').value = '';
            document.getElementById('parameter-type').value = '';
            document.getElementById('parameter-order').value = '0';
            document.getElementById('parameter-description').value = '';
            openModal('parameter-modal');
        }

        // ç¼–è¾‘å‚æ•°
        async function editParameter(parameterId, methodId) {
            try {
                const response = await fetch(`${API_BASE}/parameters/${parameterId}`);
                if (!response.ok) throw new Error('åŠ è½½å¤±è´¥');
                
                const param = await response.json();
                document.getElementById('parameter-modal-title').textContent = 'ç¼–è¾‘å‚æ•°';
                document.getElementById('parameter-id').value = param.id;
                document.getElementById('parameter-method-id').value = methodId;
                document.getElementById('parameter-name').value = param.parameterName || '';
                document.getElementById('parameter-type').value = param.parameterType || '';
                document.getElementById('parameter-order').value = param.parameterOrder || 0;
                document.getElementById('parameter-description').value = param.parameterDescription || '';
                openModal('parameter-modal');
            } catch (error) {
                console.error('åŠ è½½å‚æ•°å¤±è´¥:', error);
                alert('åŠ è½½å¤±è´¥: ' + error.message);
            }
        }

        // ä¿å­˜å‚æ•°
        async function saveParameter(e) {
            e.preventDefault();
            
            const parameterId = document.getElementById('parameter-id').value;
            const methodId = document.getElementById('parameter-method-id').value;
            const parameter = {
                methodId: parseInt(methodId),
                parameterName: document.getElementById('parameter-name').value,
                parameterType: document.getElementById('parameter-type').value,
                parameterOrder: parseInt(document.getElementById('parameter-order').value),
                parameterDescription: document.getElementById('parameter-description').value
            };

            try {
                let response;
                if (parameterId) {
                    // æ›´æ–°
                    response = await fetch(`${API_BASE}/parameters/${parameterId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(parameter)
                    });
                } else {
                    // åˆ›å»º
                    response = await fetch(`${API_BASE}/parameters`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(parameter)
                    });
                }
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'ä¿å­˜å¤±è´¥');
                }
                
                alert('ä¿å­˜æˆåŠŸ');
                closeModal('parameter-modal');
                // é‡æ–°åŠ è½½æœåŠ¡è¯¦æƒ…
                if (window.currentServiceId) {
                    viewServiceDetail(window.currentServiceId);
                }
            } catch (error) {
                console.error('ä¿å­˜å‚æ•°å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }

        // åˆ é™¤å‚æ•°
        async function deleteParameter(parameterId) {
            if (!confirm('ç¡®è®¤åˆ é™¤è¯¥å‚æ•°ï¼Ÿ')) return;

            try {
                const response = await fetch(`${API_BASE}/parameters/${parameterId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'åˆ é™¤å¤±è´¥');
                }
                
                alert('åˆ é™¤æˆåŠŸ');
                // é‡æ–°åŠ è½½æœåŠ¡è¯¦æƒ…
                if (window.currentServiceId) {
                    viewServiceDetail(window.currentServiceId);
                }
            } catch (error) {
                console.error('åˆ é™¤å‚æ•°å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        // æ‰“å¼€æ¨¡æ€æ¡†
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // æ˜¾ç¤ºæç¤º
        function showAlert(containerId, message, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="alert alert-${type}">${escapeHtml(message)}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        // è½¬ä¹‰HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
        function formatDateTime(dateTimeStr) {
            if (!dateTimeStr) return '-';
            try {
                const date = new Date(dateTimeStr);
                return date.toLocaleString('zh-CN');
            } catch (e) {
                return dateTimeStr;
            }
        }
    </script>
</body>
</html>

