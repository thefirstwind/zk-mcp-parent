<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DubboæœåŠ¡å‚æ•°ç±»å‹æµ‹è¯•é¡µé¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        .content {
            padding: 30px;
        }
        .config-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .config-section h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 18px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
            font-family: 'Courier New', monospace;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        button:active {
            transform: translateY(0);
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        .btn-secondary {
            background: #6c757d;
        }
        .btn-secondary:hover {
            background: #5a6268;
        }
        .service-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        .parameters-section {
            background: #fff;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        .parameters-section h4 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 16px;
        }
        .parameter-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .parameter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .parameter-name {
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }
        .parameter-type {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        .parameter-description {
            color: #6c757d;
            font-size: 13px;
            margin-bottom: 10px;
        }
        .parameter-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }
        .response-section {
            margin-top: 30px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
        }
        .response-section h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 18px;
        }
        .response-content {
            background: #212529;
            color: #f8f9fa;
            padding: 20px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
            word-break: break-all;
        }
        .response-success {
            border-left: 4px solid #28a745;
        }
        .response-error {
            border-left: 4px solid #dc3545;
        }
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .info-box {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
            color: #1976d2;
            font-size: 14px;
        }
        .method-info {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
            color: #856404;
            font-size: 14px;
        }
        .method-info strong {
            display: block;
            margin-bottom: 5px;
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”§ DubboæœåŠ¡å‚æ•°ç±»å‹æµ‹è¯•é¡µé¢</h1>
            <p>å‚ç…§ test-parameter-types.sh è„šæœ¬åŠŸèƒ½ï¼Œé€šè¿‡Webç•Œé¢æµ‹è¯•DubboæœåŠ¡è°ƒç”¨</p>
        </div>
        
        <div class="content">
            <!-- é…ç½®åŒºåŸŸ -->
            <div class="config-section">
                <h3>âš™ï¸ æœåŠ¡é…ç½®</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="baseUrl">æœåŠ¡åœ°å€ (Base URL):</label>
                        <input type="text" id="baseUrl" value="http://localhost:9091" placeholder="http://localhost:9091">
                    </div>
                    <div class="form-group">
                        <label for="sessionId">Session ID:</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="sessionId" value="test-web" placeholder="test-web" style="flex: 1;">
                            <button onclick="fetchSessionId()" id="fetchSessionBtn" style="padding: 12px 20px; white-space: nowrap;">
                                ğŸ”„ è·å– Session ID
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æœåŠ¡é€‰æ‹©åŒºåŸŸ -->
            <div class="config-section">
                <h3>ğŸ“‹ é€‰æ‹©æœåŠ¡å’Œæ–¹æ³•</h3>
                <div class="service-selector">
                    <div class="form-group">
                        <label for="serviceSelect">é€‰æ‹©æœåŠ¡:</label>
                        <select id="serviceSelect" onchange="loadMethods()">
                            <option value="">-- è¯·å…ˆåŠ è½½æœåŠ¡åˆ—è¡¨ --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="methodSelect">é€‰æ‹©æ–¹æ³•:</label>
                        <select id="methodSelect" onchange="loadParameters()">
                            <option value="">-- è¯·å…ˆé€‰æ‹©æœåŠ¡ --</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <button onclick="loadServices()">ğŸ”„ åŠ è½½æœåŠ¡åˆ—è¡¨</button>
                    <button onclick="loadMethods()" class="btn-secondary" id="refreshMethodsBtn" disabled>ğŸ”„ åˆ·æ–°æ–¹æ³•åˆ—è¡¨</button>
                </div>
                <div id="methodInfo" class="method-info" style="display: none;">
                    <strong>æ–¹æ³•ä¿¡æ¯:</strong>
                    <div id="methodInfoContent"></div>
                </div>
            </div>

            <!-- å‚æ•°å¡«å†™åŒºåŸŸ -->
            <div id="parametersSection" class="parameters-section" style="display: none;">
                <h4>ğŸ“ æ–¹æ³•å‚æ•°</h4>
                <div id="parametersContainer">
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“‹</div>
                        <p>è¯·å…ˆé€‰æ‹©æœåŠ¡å’Œæ–¹æ³•</p>
                    </div>
                </div>
            </div>

            <!-- æ‰‹åŠ¨è¾“å…¥å‚æ•°åŒºåŸŸ -->
            <div class="config-section">
                <h3>âœï¸ æ‰‹åŠ¨è¾“å…¥å‚æ•° (JSONæ ¼å¼)</h3>
                <div class="info-box">
                    ğŸ’¡ æç¤ºï¼šå¯ä»¥æ‰‹åŠ¨ç¼–è¾‘JSONæ ¼å¼çš„å‚æ•°ï¼Œæˆ–è€…ä½¿ç”¨ä¸Šæ–¹è‡ªåŠ¨ç”Ÿæˆçš„å‚æ•°è¡¨å•ã€‚å‚æ•°æ ¼å¼ä¸ºå¯¹è±¡ï¼Œé”®ä¸ºå‚æ•°åï¼Œå€¼ä¸ºå‚æ•°å€¼ã€‚
                </div>
                <div class="form-group">
                    <label for="manualArguments">å‚æ•° (JSON):</label>
                    <textarea id="manualArguments" placeholder='{"productId": 1}'></textarea>
                </div>
            </div>

            <!-- æ‰§è¡Œæµ‹è¯• -->
            <div class="config-section">
                <h3>ğŸš€ æ‰§è¡Œæµ‹è¯•</h3>
                <div class="form-group">
                    <label for="toolName">å·¥å…·åç§° (å®Œæ•´æ–¹æ³•å):</label>
                    <input type="text" id="toolName" placeholder="com.zkinfo.demo.service.ProductService.getProductById" readonly>
                </div>
                <button onclick="executeTest()" id="executeBtn" style="width: 100%; padding: 15px; font-size: 16px;">
                    â–¶ï¸ æ‰§è¡Œæµ‹è¯•
                </button>
            </div>

            <!-- å“åº”ç»“æœåŒºåŸŸ -->
            <div class="response-section">
                <h3>ğŸ“Š æµ‹è¯•ç»“æœ</h3>
                <div id="responseContent" class="response-content" style="display: none;"></div>
                <div id="responseEmpty" class="empty-state">
                    <div class="empty-state-icon">ğŸ“­</div>
                    <p>ç­‰å¾…æ‰§è¡Œæµ‹è¯•...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let services = [];
        let methods = [];
        let currentService = null;
        let currentMethod = null;

        // è·å–åŸºç¡€URL
        function getBaseUrl() {
            return document.getElementById('baseUrl').value.trim() || 'http://localhost:9091';
        }

        // è·å–Session ID
        function getSessionId() {
            return document.getElementById('sessionId').value.trim() || 'test-web';
        }

        // ä»SSEç«¯ç‚¹è·å–Session ID
        async function fetchSessionId() {
            const baseUrl = getBaseUrl();
            const sessionIdInput = document.getElementById('sessionId');
            const fetchBtn = document.getElementById('fetchSessionBtn');
            
            fetchBtn.disabled = true;
            fetchBtn.innerHTML = '<span class="loading"></span> è·å–ä¸­...';
            
            try {
                const endpoint = 'virtual-test-virtual-endpoint2';
                const sseUrl = `${baseUrl}/sse/${endpoint}`;
                
                console.log('è¯·æ±‚SSEç«¯ç‚¹:', sseUrl);
                
                // ä½¿ç”¨ EventSource æ¥æ¥æ”¶ SSE æµ
                return new Promise((resolve, reject) => {
                    const eventSource = new EventSource(sseUrl);
                    let sessionIdFound = false;
                    
                    // è®¾ç½®è¶…æ—¶
                    const timeout = setTimeout(() => {
                        eventSource.close();
                        if (!sessionIdFound) {
                            fetchBtn.disabled = false;
                            fetchBtn.innerHTML = 'ğŸ”„ è·å– Session ID';
                            reject(new Error('è·å–Session IDè¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç«¯ç‚¹æ˜¯å¦æ­£ç¡®'));
                        }
                    }, 10000); // 10ç§’è¶…æ—¶
                    
                    eventSource.addEventListener('endpoint', (event) => {
                        try {
                            const data = event.data;
                            console.log('æ”¶åˆ°endpointäº‹ä»¶:', data);
                            
                            // ä»URLä¸­æå–sessionId
                            // æ ¼å¼: data:http://xxxx/xxx?sessionId=xxx
                            // æˆ–è€…: http://xxxx/xxx?sessionId=xxx
                            let url = data;
                            if (url.startsWith('data:')) {
                                url = url.substring(5).trim();
                            }
                            
                            // è§£æURLè·å–sessionIdå‚æ•°
                            const urlObj = new URL(url);
                            const sessionId = urlObj.searchParams.get('sessionId');
                            
                            if (sessionId) {
                                sessionIdFound = true;
                                sessionIdInput.value = sessionId;
                                console.log('æˆåŠŸè·å–Session ID:', sessionId);
                                clearTimeout(timeout);
                                eventSource.close();
                                // æ¢å¤æŒ‰é’®çŠ¶æ€
                                fetchBtn.disabled = false;
                                // æ˜¾ç¤ºæˆåŠŸæç¤º
                                fetchBtn.innerHTML = 'âœ… å·²è·å–';
                                setTimeout(() => {
                                    fetchBtn.innerHTML = 'ğŸ”„ è·å– Session ID';
                                }, 2000);
                                resolve(sessionId);
                            } else {
                                console.warn('æœªæ‰¾åˆ°sessionIdå‚æ•°:', url);
                            }
                        } catch (error) {
                            console.error('è§£æendpointæ•°æ®å¤±è´¥:', error);
                            clearTimeout(timeout);
                            eventSource.close();
                            fetchBtn.disabled = false;
                            fetchBtn.innerHTML = 'ğŸ”„ è·å– Session ID';
                            reject(new Error('è§£æSession IDå¤±è´¥: ' + error.message));
                        }
                    });
                    
                    eventSource.addEventListener('message', (event) => {
                        // å¤„ç†å…¶ä»–æ¶ˆæ¯ç±»å‹
                        console.log('æ”¶åˆ°æ¶ˆæ¯:', event.data);
                    });
                    
                    eventSource.onerror = (error) => {
                        console.error('SSEè¿æ¥é”™è¯¯:', error);
                        clearTimeout(timeout);
                        eventSource.close();
                        if (!sessionIdFound) {
                            fetchBtn.disabled = false;
                            fetchBtn.innerHTML = 'ğŸ”„ è·å– Session ID';
                            reject(new Error('SSEè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç«¯ç‚¹æ˜¯å¦æ­£ç¡®'));
                        }
                    };
                });
            } catch (error) {
                console.error('è·å–Session IDå¤±è´¥:', error);
                alert('è·å–Session IDå¤±è´¥: ' + error.message + '\n\nè¯·æ£€æŸ¥ï¼š\n1. ç«¯ç‚¹ virtual-test-virtual-endpoint2 æ˜¯å¦å­˜åœ¨\n2. æœåŠ¡åœ°å€æ˜¯å¦æ­£ç¡®\n3. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸');
                fetchBtn.disabled = false;
                fetchBtn.innerHTML = 'ğŸ”„ è·å– Session ID';
                throw error;
            }
        }

        // åŠ è½½æœåŠ¡åˆ—è¡¨
        async function loadServices() {
            const baseUrl = getBaseUrl();
            const serviceSelect = document.getElementById('serviceSelect');
            const executeBtn = document.getElementById('executeBtn');
            
            serviceSelect.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';
            executeBtn.disabled = true;

            try {
                const response = await fetch(`${baseUrl}/api/dubbo-services?page=1&size=100`);
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('APIé”™è¯¯å“åº”:', errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('APIå“åº”:', result);
                
                // PageResultä½¿ç”¨dataå­—æ®µå­˜å‚¨åˆ—è¡¨
                services = result.data || [];
                
                serviceSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹©æœåŠ¡ --</option>';
                
                if (services.length === 0) {
                    serviceSelect.innerHTML = '<option value="">-- æš‚æ— æœåŠ¡ --</option>';
                    const total = result.total || 0;
                    const message = total === 0 
                        ? 'æ•°æ®åº“ä¸­æš‚æ— æœåŠ¡ï¼Œè¯·ç¡®ä¿ï¼š\n1. æœåŠ¡å·²æ³¨å†Œåˆ°ZooKeeper\n2. æœåŠ¡å·²å®¡æ‰¹é€šè¿‡\n3. å·²åŒæ­¥æœåŠ¡ä¿¡æ¯åˆ°æ•°æ®åº“'
                        : `å½“å‰é¡µæ— æœåŠ¡ï¼ˆæ€»æ•°: ${total}ï¼‰ï¼Œè¯·å°è¯•è°ƒæ•´åˆ†é¡µå‚æ•°`;
                    alert(message);
                    executeBtn.disabled = false; // é‡æ–°å¯ç”¨æŒ‰é’®
                    return;
                }

                services.forEach(service => {
                    const option = document.createElement('option');
                    option.value = service.id;
                    const status = service.approvalStatus || 'UNKNOWN';
                    option.textContent = `${service.interfaceName} (${service.version || 'default'}) [${status}]`;
                    serviceSelect.appendChild(option);
                });

                const total = result.total || services.length;
                console.log(`æˆåŠŸåŠ è½½ ${services.length} ä¸ªæœåŠ¡ï¼ˆå…± ${total} ä¸ªï¼‰`);
                // ä¸æ˜¾ç¤ºalertï¼Œé¿å…æ‰“æ‰°ç”¨æˆ·
                executeBtn.disabled = false; // åŠ è½½æˆåŠŸåé‡æ–°å¯ç”¨æŒ‰é’®
            } catch (error) {
                console.error('åŠ è½½æœåŠ¡åˆ—è¡¨å¤±è´¥:', error);
                serviceSelect.innerHTML = '<option value="">-- åŠ è½½å¤±è´¥ --</option>';
                alert('åŠ è½½æœåŠ¡åˆ—è¡¨å¤±è´¥: ' + error.message + '\n\nè¯·æ£€æŸ¥ï¼š\n1. æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ\n2. APIè·¯å¾„æ˜¯å¦æ­£ç¡®\n3. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸');
                executeBtn.disabled = false; // åŠ è½½å¤±è´¥åä¹Ÿè¦é‡æ–°å¯ç”¨æŒ‰é’®
            }
        }

        // åŠ è½½æ–¹æ³•åˆ—è¡¨
        async function loadMethods() {
            const baseUrl = getBaseUrl();
            const serviceSelect = document.getElementById('serviceSelect');
            const methodSelect = document.getElementById('methodSelect');
            const refreshMethodsBtn = document.getElementById('refreshMethodsBtn');
            
            const serviceId = serviceSelect.value;
            if (!serviceId) {
                methodSelect.innerHTML = '<option value="">-- è¯·å…ˆé€‰æ‹©æœåŠ¡ --</option>';
                refreshMethodsBtn.disabled = true;
                return;
            }

            currentService = services.find(s => s.id == serviceId);
            if (!currentService) {
                alert('æœªæ‰¾åˆ°é€‰ä¸­çš„æœåŠ¡');
                return;
            }

            methodSelect.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';
            refreshMethodsBtn.disabled = true;

            try {
                const response = await fetch(`${baseUrl}/api/dubbo-services/${serviceId}/methods`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                methods = await response.json();
                
                methodSelect.innerHTML = '<option value="">-- è¯·é€‰æ‹©æ–¹æ³• --</option>';
                
                if (methods.length === 0) {
                    methodSelect.innerHTML = '<option value="">-- æš‚æ— æ–¹æ³• --</option>';
                    alert('è¯¥æœåŠ¡æ²¡æœ‰æ–¹æ³•');
                    return;
                }

                methods.forEach(method => {
                    const option = document.createElement('option');
                    option.value = method.id;
                    option.textContent = `${method.methodName} (${method.returnType || 'void'})`;
                    methodSelect.appendChild(option);
                });

                refreshMethodsBtn.disabled = false;
            } catch (error) {
                console.error('åŠ è½½æ–¹æ³•åˆ—è¡¨å¤±è´¥:', error);
                methodSelect.innerHTML = '<option value="">-- åŠ è½½å¤±è´¥ --</option>';
                alert('åŠ è½½æ–¹æ³•åˆ—è¡¨å¤±è´¥: ' + error.message);
            }
        }

        // åŠ è½½å‚æ•°åˆ—è¡¨
        async function loadParameters() {
            const baseUrl = getBaseUrl();
            const methodSelect = document.getElementById('methodSelect');
            const parametersSection = document.getElementById('parametersSection');
            const parametersContainer = document.getElementById('parametersContainer');
            const methodInfo = document.getElementById('methodInfo');
            const methodInfoContent = document.getElementById('methodInfoContent');
            const toolNameInput = document.getElementById('toolName');
            
            const methodId = methodSelect.value;
            if (!methodId) {
                parametersSection.style.display = 'none';
                methodInfo.style.display = 'none';
                return;
            }

            currentMethod = methods.find(m => m.id == methodId);
            if (!currentMethod) {
                alert('æœªæ‰¾åˆ°é€‰ä¸­çš„æ–¹æ³•');
                return;
            }

            // æ›´æ–°å·¥å…·åç§°
            const fullMethodName = `${currentService.interfaceName}.${currentMethod.methodName}`;
            toolNameInput.value = fullMethodName;

            // æ˜¾ç¤ºæ–¹æ³•ä¿¡æ¯
            methodInfoContent.innerHTML = `
                <div><strong>æ¥å£:</strong> ${currentService.interfaceName}</div>
                <div><strong>æ–¹æ³•:</strong> ${currentMethod.methodName}</div>
                <div><strong>è¿”å›ç±»å‹:</strong> ${currentMethod.returnType || 'void'}</div>
                <div><strong>ç‰ˆæœ¬:</strong> ${currentService.version || 'default'}</div>
            `;
            methodInfo.style.display = 'block';

            parametersContainer.innerHTML = '<div class="empty-state"><div class="loading"></div><p>åŠ è½½å‚æ•°ä¸­...</p></div>';

            try {
                const response = await fetch(`${baseUrl}/api/dubbo-services/methods/${methodId}/parameters`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const parameters = await response.json();
                
                if (parameters.length === 0) {
                    parametersContainer.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">â„¹ï¸</div>
                            <p>è¯¥æ–¹æ³•æ²¡æœ‰å‚æ•°</p>
                        </div>
                    `;
                    parametersSection.style.display = 'block';
                    // æ¸…ç©ºæ‰‹åŠ¨è¾“å…¥
                    document.getElementById('manualArguments').value = '{}';
                    return;
                }

                // æŒ‰å‚æ•°é¡ºåºæ’åº
                parameters.sort((a, b) => (a.parameterOrder || 0) - (b.parameterOrder || 0));

                let html = '';
                parameters.forEach(param => {
                    const paramType = param.parameterType || 'Object';
                    const paramName = param.parameterName || `param${param.parameterOrder}`;
                    const paramDesc = param.parameterDescription || '';
                    
                    html += `
                        <div class="parameter-item">
                            <div class="parameter-header">
                                <span class="parameter-name">${paramName}</span>
                                <span class="parameter-type">${paramType}</span>
                            </div>
                            ${paramDesc ? `<div class="parameter-description">${paramDesc}</div>` : ''}
                            <input type="text" 
                                   class="parameter-input" 
                                   data-param-name="${paramName}"
                                   data-param-type="${paramType}"
                                   placeholder="è¾“å…¥ ${paramType} ç±»å‹çš„å€¼"
                                   onchange="updateManualArguments()">
                        </div>
                    `;
                });

                parametersContainer.innerHTML = html;
                parametersSection.style.display = 'block';
                
                // åˆå§‹åŒ–æ‰‹åŠ¨è¾“å…¥åŒºåŸŸ
                updateManualArguments();
            } catch (error) {
                console.error('åŠ è½½å‚æ•°åˆ—è¡¨å¤±è´¥:', error);
                parametersContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">âŒ</div>
                        <p>åŠ è½½å‚æ•°å¤±è´¥: ${error.message}</p>
                    </div>
                `;
                parametersSection.style.display = 'block';
            }
        }

        // æ›´æ–°æ‰‹åŠ¨è¾“å…¥åŒºåŸŸ
        function updateManualArguments() {
            const paramInputs = document.querySelectorAll('.parameter-input');
            const manualInput = document.getElementById('manualArguments');
            
            const arguments = {};
            paramInputs.forEach(input => {
                const paramName = input.dataset.paramName;
                const paramType = input.dataset.paramType;
                const value = input.value.trim();
                
                if (value) {
                    // æ ¹æ®ç±»å‹è½¬æ¢å€¼
                    try {
                        if (paramType.includes('int') || paramType.includes('Integer') || paramType.includes('Long') || paramType.includes('long')) {
                            arguments[paramName] = parseInt(value) || 0;
                        } else if (paramType.includes('double') || paramType.includes('Double') || paramType.includes('Float') || paramType.includes('float')) {
                            arguments[paramName] = parseFloat(value) || 0.0;
                        } else if (paramType.includes('boolean') || paramType.includes('Boolean')) {
                            arguments[paramName] = value.toLowerCase() === 'true';
                        } else if (value.startsWith('{') || value.startsWith('[')) {
                            // JSONå¯¹è±¡æˆ–æ•°ç»„
                            arguments[paramName] = JSON.parse(value);
                        } else {
                            arguments[paramName] = value;
                        }
                    } catch (e) {
                        // å¦‚æœè§£æå¤±è´¥ï¼Œä½¿ç”¨åŸå§‹å­—ç¬¦ä¸²
                        arguments[paramName] = value;
                    }
                }
            });
            
            manualInput.value = JSON.stringify(arguments, null, 2);
        }

        // SSEè¿æ¥ç®¡ç†
        let sseEventSource = null;
        let currentRequestId = null;
        let responseBuffer = [];
        let sseConnectionReady = false;
        let isReceivingResponse = false; // æ ‡è®°æ˜¯å¦æ­£åœ¨æ¥æ”¶å“åº”

        // è¾…åŠ©å‡½æ•°ï¼šæ›´æ–°å“åº”å†…å®¹ï¼ˆç”¨äºæ˜¾ç¤ºä¸´æ—¶çŠ¶æ€ï¼Œä¸ä¼šè¦†ç›–SSEå“åº”ï¼‰
        function updateResponseContent(text, isFinalResponse = false) {
            const responseContent = document.getElementById('responseContent');
            const responseEmpty = document.getElementById('responseEmpty');
            
            if (!responseContent) return;
            
            // å¦‚æœæ­£åœ¨æ¥æ”¶SSEå“åº”ï¼Œä¸”è¿™ä¸æ˜¯æœ€ç»ˆå“åº”ï¼Œåˆ™ä¸æ›´æ–°ï¼ˆé¿å…è¦†ç›–ï¼‰
            if (isReceivingResponse && !isFinalResponse) {
                console.log('æ­£åœ¨æ¥æ”¶SSEå“åº”ï¼Œè·³è¿‡ä¸´æ—¶çŠ¶æ€æ›´æ–°');
                return;
            }
            
            if (responseEmpty) {
                responseEmpty.style.display = 'none';
            }
            responseContent.style.display = 'block';
            responseContent.textContent = text;
        }
        
        // å¼ºåˆ¶æ›´æ–°å“åº”å†…å®¹ï¼ˆç”¨äºSSEå“åº”ï¼Œä¼šè¦†ç›–ä»»ä½•ä¸´æ—¶çŠ¶æ€ï¼‰
        function forceUpdateResponseContent(text) {
            const responseContent = document.getElementById('responseContent');
            const responseEmpty = document.getElementById('responseEmpty');
            
            if (!responseContent) {
                console.error('responseContentå…ƒç´ ä¸å­˜åœ¨');
                return;
            }
            
            if (responseEmpty) {
                responseEmpty.style.display = 'none';
            }
            responseContent.style.display = 'block';
            responseContent.style.visibility = 'visible';
            responseContent.style.opacity = '1';
            responseContent.textContent = text;
            
            // å¼ºåˆ¶è§¦å‘é‡ç»˜
            void responseContent.offsetHeight;
        }

        // å»ºç«‹SSEè¿æ¥ä»¥æ¥æ”¶å®æ—¶å“åº”
        function establishSseConnection(sessionId) {
            return new Promise((resolve, reject) => {
                const baseUrl = getBaseUrl();
                const endpoint = 'virtual-test-virtual-endpoint2';
                const sseUrl = `${baseUrl}/sse/${endpoint}`;
                
                // å¦‚æœå·²æœ‰è¿æ¥ä¸”å·²å°±ç»ªï¼Œç›´æ¥ä½¿ç”¨
                if (sseEventSource && sseEventSource.readyState === EventSource.OPEN && sseConnectionReady) {
                    console.log('å¤ç”¨ç°æœ‰SSEè¿æ¥ï¼ˆå·²å°±ç»ªï¼‰');
                    resolve(sseEventSource);
                    return;
                }
                
                // å…³é—­æ—§è¿æ¥
                if (sseEventSource) {
                    console.log('å…³é—­æ—§SSEè¿æ¥');
                    sseEventSource.close();
                    sseEventSource = null;
                    sseConnectionReady = false;
                }
                
                console.log('å»ºç«‹SSEè¿æ¥:', sseUrl);
                sseEventSource = new EventSource(sseUrl);
                sseConnectionReady = false;
                
                // é‡è¦ï¼šå…ˆæ³¨å†Œæ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨ï¼Œå†ç­‰å¾…è¿æ¥æ‰“å¼€
                // è¿™æ ·å¯ä»¥ç¡®ä¿åœ¨è¿æ¥å»ºç«‹åç«‹å³èƒ½æ¥æ”¶åˆ°æ¶ˆæ¯
                
                // ç›‘å¬endpointäº‹ä»¶ï¼ˆè·å–sessionIdï¼‰
                sseEventSource.addEventListener('endpoint', (event) => {
                    const data = event.data;
                    let url = data.startsWith('data:') ? data.substring(5).trim() : data;
                    try {
                        const urlObj = new URL(url);
                        const extractedSessionId = urlObj.searchParams.get('sessionId');
                        if (extractedSessionId && extractedSessionId !== sessionId) {
                            console.log('SSEè¿æ¥è¿”å›çš„sessionId:', extractedSessionId);
                            // æ›´æ–°è¾“å…¥æ¡†ä¸­çš„sessionId
                            document.getElementById('sessionId').value = extractedSessionId;
                        }
                    } catch (e) {
                        console.warn('è§£æendpoint URLå¤±è´¥:', e);
                    }
                });
                
                // ç›‘å¬messageäº‹ä»¶ï¼ˆæ¥æ”¶MCPå“åº”ï¼‰
                sseEventSource.addEventListener('message', (event) => {
                    try {
                        console.log('========== æ”¶åˆ°SSE messageäº‹ä»¶ ==========');
                        console.log('åŸå§‹æ•°æ®:', event.data);
                        console.log('æ•°æ®ç±»å‹:', typeof event.data);
                        console.log('äº‹ä»¶ç±»å‹:', event.type);
                        console.log('å½“å‰è¯·æ±‚ID:', currentRequestId);
                        
                        // æ•°æ®å¯èƒ½æ˜¯JSONå­—ç¬¦ä¸²
                        let data = event.data;
                        if (typeof data === 'string') {
                            // å°è¯•è§£æJSON
                            try {
                                data = JSON.parse(data);
                                console.log('âœ… JSONè§£ææˆåŠŸ:', data);
                            } catch (e) {
                                // å¦‚æœä¸æ˜¯JSONï¼Œç›´æ¥ä½¿ç”¨å­—ç¬¦ä¸²
                                console.log('âš ï¸ æ”¶åˆ°éJSONæ¶ˆæ¯:', data);
                                // å³ä½¿ä¸æ˜¯JSONï¼Œä¹Ÿå°è¯•å¤„ç†ï¼ˆå¯èƒ½æ˜¯çº¯æ–‡æœ¬å“åº”ï¼‰
                                console.log('å°è¯•å¤„ç†éJSONæ¶ˆæ¯...');
                                handleMcpResponse({ 
                                    text: data,
                                    raw: event.data,
                                    id: currentRequestId 
                                });
                                return;
                            }
                        }
                        
                        console.log('è§£æåçš„æ•°æ®:', data);
                        console.log('æ•°æ®ID:', data.id);
                        console.log('æ•°æ®æ˜¯å¦æœ‰error:', !!data.error);
                        console.log('æ•°æ®æ˜¯å¦æœ‰result:', !!data.result);
                        
                        // æ— è®ºIDæ˜¯å¦åŒ¹é…ï¼Œéƒ½æ˜¾ç¤ºå“åº”ï¼ˆç¡®ä¿æ‰€æœ‰æ¶ˆæ¯éƒ½èƒ½æ˜¾ç¤ºï¼‰
                        console.log('å‡†å¤‡è°ƒç”¨handleMcpResponse...');
                        handleMcpResponse(data);
                        console.log('handleMcpResponseè°ƒç”¨å®Œæˆ');
                        
                    } catch (e) {
                        console.error('âŒ å¤„ç†SSEæ¶ˆæ¯å¤±è´¥:', e);
                        console.error('é”™è¯¯å †æ ˆ:', e.stack);
                        console.error('äº‹ä»¶å¯¹è±¡:', event);
                        // å³ä½¿å‡ºé”™ï¼Œä¹Ÿå°è¯•æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                        try {
                            handleMcpResponse({
                                error: {
                                    code: -32603,
                                    message: 'å¤„ç†SSEæ¶ˆæ¯å¤±è´¥: ' + e.message
                                },
                                rawEvent: event.data
                            });
                        } catch (e2) {
                            console.error('æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ä¹Ÿå¤±è´¥:', e2);
                            alert('å¤„ç†å“åº”å¤±è´¥: ' + e.message);
                        }
                    }
                });
                
                // ç›‘å¬æ‰€æœ‰äº‹ä»¶ç±»å‹ï¼ˆåŒ…æ‹¬è‡ªå®šä¹‰äº‹ä»¶ï¼‰
                sseEventSource.addEventListener('response', (event) => {
                    try {
                        let data = event.data;
                        if (typeof data === 'string') {
                            try {
                                data = JSON.parse(data);
                            } catch (e) {
                                console.log('æ”¶åˆ°éJSON responseäº‹ä»¶:', data);
                                return;
                            }
                        }
                        console.log('æ”¶åˆ°responseäº‹ä»¶:', data);
                        if (data.id && data.id === currentRequestId) {
                            handleMcpResponse(data);
                        }
                    } catch (e) {
                        console.error('å¤„ç†responseäº‹ä»¶å¤±è´¥:', e, event);
                    }
                });
                
                // ç›‘å¬heartbeatäº‹ä»¶ï¼ˆå¿ƒè·³æ¶ˆæ¯ï¼Œå¯ä»¥å¿½ç•¥ï¼‰
                sseEventSource.addEventListener('heartbeat', (event) => {
                    console.log('æ”¶åˆ°å¿ƒè·³:', event.data);
                });
                
                // ç›‘å¬æ‰€æœ‰æœªå‘½åäº‹ä»¶ï¼ˆé»˜è®¤messageäº‹ä»¶ï¼Œä½œä¸ºå¤‡ç”¨ï¼‰
                sseEventSource.onmessage = (event) => {
                    console.log('========== æ”¶åˆ°SSEé»˜è®¤onmessageäº‹ä»¶ ==========');
                    console.log('äº‹ä»¶æ•°æ®:', event.data);
                    console.log('äº‹ä»¶ç±»å‹:', event.type);
                    console.log('å½“å‰è¯·æ±‚ID:', currentRequestId);
                    
                    // å¦‚æœä¸Šé¢çš„messageäº‹ä»¶ç›‘å¬å™¨æ²¡æœ‰å¤„ç†ï¼Œè¿™é‡Œä½œä¸ºå¤‡ç”¨å¤„ç†
                    try {
                        let data = event.data;
                        if (typeof data === 'string') {
                            try {
                                data = JSON.parse(data);
                                console.log('onmessage: JSONè§£ææˆåŠŸ:', data);
                            } catch (e) {
                                console.log('onmessage: éJSONæ•°æ®:', data);
                                // å³ä½¿ä¸æ˜¯JSONï¼Œä¹Ÿå°è¯•å¤„ç†
                                handleMcpResponse({ 
                                    text: data,
                                    raw: event.data,
                                    id: currentRequestId 
                                });
                                return;
                            }
                        }
                        
                        console.log('onmessage: è§£æåçš„æ•°æ®:', data);
                        console.log('onmessage: æ•°æ®ID:', data.id);
                        console.log('onmessage: æ˜¯å¦æœ‰error:', !!data.error);
                        
                        // æ— è®ºIDæ˜¯å¦åŒ¹é…ï¼Œéƒ½æ˜¾ç¤ºå“åº”ï¼ˆç¡®ä¿æ‰€æœ‰æ¶ˆæ¯éƒ½èƒ½æ˜¾ç¤ºï¼‰
                        console.log('onmessage: å‡†å¤‡è°ƒç”¨handleMcpResponse...');
                        handleMcpResponse(data);
                        console.log('onmessage: handleMcpResponseè°ƒç”¨å®Œæˆ');
                    } catch (e) {
                        console.error('âŒ onmessageå¤„ç†å¤±è´¥:', e);
                        console.error('é”™è¯¯å †æ ˆ:', e.stack);
                        // å³ä½¿å‡ºé”™ï¼Œä¹Ÿå°è¯•æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                        try {
                            handleMcpResponse({
                                error: {
                                    code: -32603,
                                    message: 'onmessageå¤„ç†å¤±è´¥: ' + e.message
                                },
                                rawEvent: event.data
                            });
                        } catch (e2) {
                            console.error('æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ä¹Ÿå¤±è´¥:', e2);
                            alert('å¤„ç†å“åº”å¤±è´¥: ' + e.message);
                        }
                    }
                };
                
                // è®¾ç½®è¿æ¥è¶…æ—¶
                const connectTimeout = setTimeout(() => {
                    if (sseEventSource.readyState !== EventSource.OPEN) {
                        console.error('SSEè¿æ¥è¶…æ—¶ï¼ŒçŠ¶æ€:', sseEventSource.readyState);
                        sseEventSource.close();
                        sseConnectionReady = false;
                        reject(new Error('SSEè¿æ¥è¶…æ—¶ï¼š5ç§’å†…æœªèƒ½å»ºç«‹è¿æ¥'));
                    }
                }, 10000); // å¢åŠ åˆ°10ç§’è¶…æ—¶
                
                // è®¾ç½®onopenå›è°ƒï¼ˆå¿…é¡»åœ¨æ‰€æœ‰addEventListenerä¹‹åï¼‰
                sseEventSource.onopen = () => {
                    clearTimeout(connectTimeout);
                    sseConnectionReady = true;
                    console.log('âœ… SSEè¿æ¥å·²å»ºç«‹ï¼ŒçŠ¶æ€:', sseEventSource.readyState, 'URL:', sseEventSource.url);
                    console.log('âœ… æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨å·²æ³¨å†Œï¼Œå¯ä»¥æ¥æ”¶æ¶ˆæ¯');
                    // ç«‹å³resolveï¼Œä¸éœ€è¦ç­‰å¾…ï¼Œå› ä¸ºäº‹ä»¶ç›‘å¬å™¨å·²ç»æ³¨å†Œå¥½äº†
                    resolve(sseEventSource);
                };
                
                sseEventSource.onerror = (error) => {
                    console.error('âŒ SSEè¿æ¥é”™è¯¯:', error, 'çŠ¶æ€:', sseEventSource.readyState);
                    if (sseEventSource.readyState === EventSource.CLOSED) {
                        console.error('SSEè¿æ¥å·²å…³é—­');
                        clearTimeout(connectTimeout);
                        reject(new Error('SSEè¿æ¥å¤±è´¥ï¼šè¿æ¥å·²å…³é—­'));
                    } else if (sseEventSource.readyState === EventSource.CONNECTING) {
                        console.warn('SSEè¿æ¥ä»åœ¨è¿æ¥ä¸­...');
                        // ä¸ç«‹å³æ‹’ç»ï¼Œç­‰å¾…è¿æ¥å®Œæˆ
                    }
                };
            });
        }

        // å¤„ç†MCPå“åº”
        function handleMcpResponse(responseData) {
            console.log('========== handleMcpResponseè¢«è°ƒç”¨ ==========');
            console.log('å“åº”æ•°æ®:', JSON.stringify(responseData, null, 2));
            console.log('å“åº”æ•°æ®ç±»å‹:', typeof responseData);
            console.log('å½“å‰è¯·æ±‚ID:', currentRequestId);
            console.log('å“åº”ç¼“å†²åŒºé•¿åº¦:', responseBuffer.length);
            
            // æ ‡è®°æ­£åœ¨æ¥æ”¶å“åº”
            isReceivingResponse = true;
            
            // æ¸…é™¤å“åº”è¶…æ—¶
            if (window.clearResponseTimeout) {
                window.clearResponseTimeout();
            }
            
            // ä½¿ç”¨requestAnimationFrameç¡®ä¿DOMæ›´æ–°åœ¨ä¸‹ä¸€å¸§æ‰§è¡Œ
            requestAnimationFrame(() => {
                try {
                    const responseContent = document.getElementById('responseContent');
                    const responseEmpty = document.getElementById('responseEmpty');
                    
                    if (!responseContent) {
                        console.error('âŒ responseContentå…ƒç´ ä¸å­˜åœ¨ï¼');
                        alert('é”™è¯¯ï¼šå“åº”å†…å®¹åŒºåŸŸä¸å­˜åœ¨ï¼');
                        return;
                    }
                    
                    console.log('æ‰¾åˆ°responseContentå…ƒç´ ');
                    
                    // ç¡®ä¿å“åº”å†…å®¹åŒºåŸŸå¯è§
                    if (responseEmpty) {
                        responseEmpty.style.display = 'none';
                        console.log('éšè—ç©ºçŠ¶æ€æç¤º');
                    }
                    
                    // å¼ºåˆ¶è®¾ç½®æ˜¾ç¤ºå±æ€§
                    responseContent.style.display = 'block';
                    responseContent.style.visibility = 'visible';
                    responseContent.style.opacity = '1';
                    console.log('æ˜¾ç¤ºå“åº”å†…å®¹åŒºåŸŸ');
                    
                    // æ·»åŠ åˆ°å“åº”ç¼“å†²åŒº
                    responseBuffer.push({
                        timestamp: new Date().toISOString(),
                        data: responseData
                    });
                    console.log('å·²æ·»åŠ åˆ°å“åº”ç¼“å†²åŒºï¼Œå½“å‰é•¿åº¦:', responseBuffer.length);
                    
                    // æ ¼å¼åŒ–å¹¶æ˜¾ç¤ºå“åº”
                    const formattedResponse = JSON.stringify({
                        requestId: currentRequestId,
                        responses: responseBuffer,
                        latestResponse: responseData,
                        timestamp: new Date().toISOString()
                    }, null, 2);
                    
                    console.log('æ ¼å¼åŒ–å“åº”å®Œæˆï¼Œé•¿åº¦:', formattedResponse.length);
                    console.log('å‡†å¤‡æ›´æ–°DOMï¼Œå“åº”å†…å®¹å‰200å­—ç¬¦:', formattedResponse.substring(0, 200));
                    
                    // å¼ºåˆ¶æ›´æ–°å†…å®¹ - ä½¿ç”¨è¾…åŠ©å‡½æ•°ç¡®ä¿æ›´æ–°æˆåŠŸ
                    forceUpdateResponseContent(formattedResponse);
                    
                    // éªŒè¯å†…å®¹æ˜¯å¦æ›´æ–°
                    const actualContent = responseContent.textContent || responseContent.innerText || '';
                    console.log('âœ… DOMæ›´æ–°åï¼Œå®é™…å†…å®¹é•¿åº¦:', actualContent.length);
                    
                    if (actualContent.length === 0) {
                        console.error('âŒ è­¦å‘Šï¼šå†…å®¹æ›´æ–°åé•¿åº¦ä¸º0ï¼å°è¯•ä½¿ç”¨innerHTML...');
                        // ä½¿ç”¨innerHTMLä½œä¸ºå¤‡ç”¨
                        responseContent.innerHTML = '<pre style="margin:0;padding:15px;white-space:pre-wrap;word-wrap:break-word;">' + 
                            formattedResponse.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</pre>';
                        console.log('ä½¿ç”¨innerHTMLæ›´æ–°ï¼Œé•¿åº¦:', responseContent.innerHTML.length);
                    }
                    
                    // å¼ºåˆ¶è§¦å‘é‡ç»˜
                    void responseContent.offsetHeight; // è§¦å‘é‡æ’
                    
                    // åˆ¤æ–­æˆåŠŸæˆ–å¤±è´¥å¹¶åº”ç”¨æ ·å¼
                    if (responseData.error) {
                        console.log('æ£€æµ‹åˆ°é”™è¯¯å“åº”ï¼Œåº”ç”¨é”™è¯¯æ ·å¼');
                        responseContent.classList.remove('response-success');
                        responseContent.classList.add('response-error');
                    } else if (responseData.result) {
                        console.log('æ£€æµ‹åˆ°æˆåŠŸå“åº”ï¼Œåº”ç”¨æˆåŠŸæ ·å¼');
                        responseContent.classList.remove('response-error');
                        responseContent.classList.add('response-success');
                    } else {
                        console.log('å“åº”æ—¢æ²¡æœ‰errorä¹Ÿæ²¡æœ‰resultï¼Œä½¿ç”¨é»˜è®¤æ ·å¼');
                    }
                    
                    // éªŒè¯æœ€ç»ˆçŠ¶æ€
                    const computedStyle = window.getComputedStyle(responseContent);
                    const finalContent = responseContent.textContent || responseContent.innerText || '';
                    console.log('æœ€ç»ˆçŠ¶æ€éªŒè¯:', {
                        display: computedStyle.display,
                        visibility: computedStyle.visibility,
                        opacity: computedStyle.opacity,
                        contentLength: finalContent.length,
                        hasContent: finalContent.length > 0
                    });
                    
                    // æ»šåŠ¨åˆ°å“åº”åŒºåŸŸï¼ˆå»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿å†…å®¹å·²æ¸²æŸ“ï¼‰
                    setTimeout(() => {
                        responseContent.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }, 50);
                    
                    console.log('========== handleMcpResponseå®Œæˆ ==========');
                } catch (e) {
                    console.error('âŒ handleMcpResponseæ‰§è¡Œå¤±è´¥:', e);
                    console.error('é”™è¯¯å †æ ˆ:', e.stack);
                    alert('æ›´æ–°å“åº”å†…å®¹å¤±è´¥: ' + e.message);
                } finally {
                    // æ ‡è®°å“åº”æ¥æ”¶å®Œæˆ
                    isReceivingResponse = false;
                }
            });
        }

        // æ‰§è¡Œæµ‹è¯•
        async function executeTest() {
            const baseUrl = getBaseUrl();
            let sessionId = getSessionId();
            const toolName = document.getElementById('toolName').value.trim();
            const manualArguments = document.getElementById('manualArguments').value.trim();
            const responseContent = document.getElementById('responseContent');
            const responseEmpty = document.getElementById('responseEmpty');
            const executeBtn = document.getElementById('executeBtn');

            if (!toolName) {
                alert('è¯·å…ˆé€‰æ‹©æœåŠ¡å’Œæ–¹æ³•');
                return;
            }

            let argumentsObj = {};
            try {
                if (manualArguments) {
                    argumentsObj = JSON.parse(manualArguments);
                }
            } catch (e) {
                alert('å‚æ•°JSONæ ¼å¼é”™è¯¯: ' + e.message);
                return;
            }

            executeBtn.disabled = true;
            executeBtn.innerHTML = '<span class="loading"></span> æ‰§è¡Œä¸­...';
            responseEmpty.style.display = 'none';
            responseContent.style.display = 'block';
            // ä½¿ç”¨è¾…åŠ©å‡½æ•°æ›´æ–°å†…å®¹ï¼Œé¿å…ç›´æ¥æ“ä½œDOM
            updateResponseContent('æ­£åœ¨å»ºç«‹SSEè¿æ¥...', false);
            responseBuffer = []; // æ¸…ç©ºå“åº”ç¼“å†²åŒº

            try {
                // 1. å»ºç«‹SSEè¿æ¥ï¼ˆç¡®ä¿è¿æ¥å®Œå…¨å»ºç«‹ï¼‰
                console.log('æ­¥éª¤1: å»ºç«‹SSEè¿æ¥...');
                await establishSseConnection(sessionId);
                
                // éªŒè¯è¿æ¥çŠ¶æ€
                if (!sseEventSource || sseEventSource.readyState !== EventSource.OPEN) {
                    throw new Error('SSEè¿æ¥æœªå°±ç»ªï¼ŒçŠ¶æ€: ' + (sseEventSource ? sseEventSource.readyState : 'null'));
                }
                console.log('âœ… SSEè¿æ¥å·²å°±ç»ªï¼ŒçŠ¶æ€:', sseEventSource.readyState);
                
                // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ç¡®ä¿è¿æ¥ç¨³å®š
                await new Promise(resolve => setTimeout(resolve, 200));
                
                // æ›´æ–°sessionIdï¼ˆå¯èƒ½ä»SSEè¿æ¥ä¸­è·å–ï¼‰
                sessionId = getSessionId();
                console.log('ä½¿ç”¨SessionId:', sessionId);
                
                // 2. å‡†å¤‡è¯·æ±‚
                currentRequestId = `test-${Date.now()}`;
                console.log('å½“å‰è¯·æ±‚ID:', currentRequestId);
                const requestBody = {
                    jsonrpc: "2.0",
                    id: currentRequestId,
                    method: "tools/call",
                    params: {
                        name: toolName,
                        arguments: argumentsObj
                    }
                };
                
                // æ˜¾ç¤ºè¯·æ±‚ä¿¡æ¯ï¼ˆä½†ä¸è¦†ç›–åç»­çš„å“åº”ï¼‰
                const requestInfo = 'SSEè¿æ¥å·²å»ºç«‹ï¼Œæ­£åœ¨å‘é€è¯·æ±‚...\n\nè¯·æ±‚ID: ' + currentRequestId + '\n\nè¯·æ±‚å†…å®¹:\n' + JSON.stringify(requestBody, null, 2);
                updateResponseContent(requestInfo, false);
                
                // 3. å‘é€è¯·æ±‚ï¼ˆå“åº”å°†é€šè¿‡SSEæ¥æ”¶ï¼‰
                console.log('æ­¥éª¤2: å‘é€MCPè¯·æ±‚...', requestBody);
                const response = await fetch(`${baseUrl}/mcp/message?sessionId=${sessionId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                console.log('æ­¥éª¤3: æ”¶åˆ°HTTPå“åº”ï¼ŒçŠ¶æ€:', response.status);

                // 4. æ£€æŸ¥HTTPå“åº”çŠ¶æ€
                console.log('HTTPå“åº”çŠ¶æ€:', response.status, response.statusText);
                if (response.status === 202) {
                    // 202 Accepted è¡¨ç¤ºè¯·æ±‚å·²æ¥å—ï¼Œå“åº”å°†é€šè¿‡SSEå‘é€
                    const waitingMsg = 'è¯·æ±‚å·²å‘é€ï¼ˆ202 Acceptedï¼‰ï¼Œç­‰å¾…å®æ—¶å“åº”...\n\nè¯·æ±‚ID: ' + currentRequestId + '\n\nè¯·æ±‚å†…å®¹:\n' + JSON.stringify(requestBody, null, 2);
                    updateResponseContent(waitingMsg, false);
                    
                    // è®¾ç½®è¶…æ—¶ï¼Œå¦‚æœ30ç§’å†…æ²¡æœ‰æ”¶åˆ°å“åº”ï¼Œæ˜¾ç¤ºæç¤º
                    let timeoutId = setTimeout(() => {
                        if (responseBuffer.length === 0) {
                            console.warn('âš ï¸ 30ç§’å†…æœªæ”¶åˆ°å“åº”');
                            const timeoutMsg = {
                                error: {
                                    code: -32000,
                                    message: 'å“åº”è¶…æ—¶ï¼š30ç§’å†…æœªæ”¶åˆ°å“åº”ï¼Œè¯·æ£€æŸ¥ï¼š\n1. SSEè¿æ¥æ˜¯å¦æ­£å¸¸\n2. æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ\n3. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°è·å–æ›´å¤šä¿¡æ¯'
                                },
                                id: currentRequestId
                            };
                            handleMcpResponse(timeoutMsg);
                        }
                    }, 30000);
                    
                    window.currentTimeoutId = timeoutId; // ä¿å­˜åˆ°å…¨å±€å˜é‡
                    window.clearResponseTimeout = function() {
                        if (window.currentTimeoutId) {
                            clearTimeout(window.currentTimeoutId);
                            window.currentTimeoutId = null;
                        }
                    };
                    
                    // å¯åŠ¨è½®è¯¢æœºåˆ¶ä½œä¸ºå¤‡ç”¨ï¼ˆå¦‚æœSSEæ¶ˆæ¯ä¸¢å¤±ï¼‰
                    startPollingResponse(currentRequestId, sessionId, timeoutId);
                    
                    // å“åº”å°†é€šè¿‡SSEçš„messageäº‹ä»¶æ¥æ”¶ï¼Œç”±handleMcpResponseå¤„ç†
                    // åœ¨handleMcpResponseä¸­ä¼šæ¸…é™¤è¶…æ—¶
                } else {
                    // å¦‚æœä¸æ˜¯202ï¼Œå°è¯•è§£æJSONå“åº”
                    let responseData;
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        responseData = await response.json();
                        handleMcpResponse(responseData);
                    } else {
                        const text = await response.text();
                        responseData = {
                            error: {
                                code: response.status,
                                message: `HTTP ${response.status}: ${response.statusText}`,
                                data: text
                            }
                        };
                        handleMcpResponse(responseData);
                    }
                }

            } catch (error) {
                console.error('æ‰§è¡Œæµ‹è¯•å¤±è´¥:', error);
                responseContent.textContent = `é”™è¯¯: ${error.message}\n\nå †æ ˆ:\n${error.stack}`;
                responseContent.classList.add('response-error');
            } finally {
                executeBtn.disabled = false;
                executeBtn.innerHTML = 'â–¶ï¸ æ‰§è¡Œæµ‹è¯•';
            }
        }

        // è½®è¯¢å“åº”ï¼ˆä½œä¸ºSSEçš„å¤‡ç”¨æ–¹æ¡ˆï¼‰
        let pollingInterval = null;
        function startPollingResponse(requestId, sessionId, timeoutId) {
            // å¦‚æœå·²ç»æœ‰è½®è¯¢ï¼Œå…ˆæ¸…é™¤
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
            
            const baseUrl = getBaseUrl();
            let pollCount = 0;
            const maxPolls = 60; // æœ€å¤šè½®è¯¢60æ¬¡ï¼ˆ30ç§’ï¼Œæ¯æ¬¡0.5ç§’ï¼‰
            
            pollingInterval = setInterval(async () => {
                pollCount++;
                
                // å¦‚æœå·²ç»æ”¶åˆ°å“åº”ï¼Œåœæ­¢è½®è¯¢
                if (responseBuffer.length > 0) {
                    console.log('å·²æ”¶åˆ°å“åº”ï¼Œåœæ­¢è½®è¯¢');
                    clearInterval(pollingInterval);
                    pollingInterval = null;
                    return;
                }
                
                // å¦‚æœè¶…è¿‡æœ€å¤§è½®è¯¢æ¬¡æ•°ï¼Œåœæ­¢
                if (pollCount >= maxPolls) {
                    console.log('è½®è¯¢è¶…æ—¶ï¼Œåœæ­¢è½®è¯¢');
                    clearInterval(pollingInterval);
                    pollingInterval = null;
                    return;
                }
                
                // è½®è¯¢æ£€æŸ¥å“åº”ï¼ˆé€šè¿‡é‡æ–°å‘é€è¯·æ±‚è·å–å“åº”ï¼‰
                // æ³¨æ„ï¼šè¿™é‡Œä¸èƒ½ç›´æ¥æŸ¥è¯¢å“åº”ï¼Œå› ä¸ºMCPåè®®ä¸æ”¯æŒæŸ¥è¯¢
                // æ‰€ä»¥è½®è¯¢ä¸»è¦æ˜¯ä½œä¸ºç›‘æ§ï¼Œå®é™…å“åº”è¿˜æ˜¯é€šè¿‡SSEæ¥æ”¶
                console.log(`è½®è¯¢æ£€æŸ¥å“åº” (${pollCount}/${maxPolls})...`);
                
            }, 500); // æ¯0.5ç§’è½®è¯¢ä¸€æ¬¡
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½æœåŠ¡åˆ—è¡¨
        window.addEventListener('load', () => {
            // å¯ä»¥è‡ªåŠ¨åŠ è½½ï¼Œä¹Ÿå¯ä»¥è®©ç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»
            // loadServices();
        });
    </script>
</body>
</html>

