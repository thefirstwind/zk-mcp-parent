<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCPåè®®æµ‹è¯•å®¢æˆ·ç«¯</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s;
        }
        .tab.active {
            background: white;
            color: #495057;
            border-bottom: 2px solid #667eea;
        }
        .tab-content {
            display: none;
            padding: 20px;
        }
        .tab-content.active {
            display: block;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
        }
        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        textarea {
            height: 120px;
            resize: vertical;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.3s;
        }
        button:hover {
            background: #5a6fd8;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .response {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .success {
            border-color: #28a745;
            background-color: #d4edda;
        }
        .error {
            border-color: #dc3545;
            background-color: #f8d7da;
        }
        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .tool-card {
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            background: #f8f9fa;
        }
        .tool-name {
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
        }
        .tool-description {
            color: #6c757d;
            font-size: 13px;
            margin-bottom: 10px;
        }
        .tool-meta {
            font-size: 11px;
            color: #868e96;
        }
        .status-online {
            color: #28a745;
            font-weight: 500;
        }
        .status-offline {
            color: #dc3545;
            font-weight: 500;
        }
        .stream-log {
            background: #212529;
            color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }
        .stream-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        .stream-timestamp {
            color: #6c757d;
        }
        .stream-data {
            color: #28a745;
        }
        .stream-error {
            color: #dc3545;
        }
        .preset-selector {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 15px;
        }
        .preset-selector label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
        }
        .preset-selector select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            background: white;
            font-size: 14px;
        }
        .preset-info {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            font-size: 13px;
            color: #1976d2;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”§ MCPåè®®æµ‹è¯•å®¢æˆ·ç«¯</h1>
            <p>æµ‹è¯•zkInfoçš„æ ‡å‡†MCPåè®®æ”¯æŒ - JSON-RPC 2.0, SSE, WebSocket</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('tools')">å·¥å…·åˆ—è¡¨</button>
            <button class="tab" onclick="switchTab('jsonrpc')">JSON-RPCè°ƒç”¨</button>
            <button class="tab" onclick="switchTab('sse')">SSEæµå¼è°ƒç”¨</button>
            <button class="tab" onclick="switchTab('websocket')">WebSocket</button>
        </div>
        
        <!-- å·¥å…·åˆ—è¡¨æ ‡ç­¾é¡µ -->
        <div id="tools" class="tab-content active">
            <h3>ğŸ“‹ å¯ç”¨çš„MCPå·¥å…·</h3>
            <button onclick="loadTools()">ğŸ”„ åˆ·æ–°å·¥å…·åˆ—è¡¨</button>
            <div id="toolsList" class="tools-grid">
                <!-- å·¥å…·åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
            </div>
        </div>
        
        <!-- JSON-RPCè°ƒç”¨æ ‡ç­¾é¡µ -->
        <div id="jsonrpc" class="tab-content">
            <h3>ğŸš€ JSON-RPC 2.0 è°ƒç”¨</h3>
            <div class="form-group">
                <label for="rpcMethod">æ–¹æ³•å:</label>
                <select id="rpcMethod" onchange="updateMethodParams()">
                    <option value="initialize">initialize - åˆå§‹åŒ–è¿æ¥</option>
                    <option value="tools/list">tools/list - è·å–å·¥å…·åˆ—è¡¨</option>
                    <option value="tools/call">tools/call - è°ƒç”¨å·¥å…·</option>
                    <option value="ping">ping - å¿ƒè·³æ£€æµ‹</option>
                </select>
            </div>
            <div class="form-group">
                <label for="rpcParams">å‚æ•° (JSONæ ¼å¼):</label>
                <textarea id="rpcParams" placeholder='{"protocolVersion": "2024-11-05", "clientInfo": {"name": "test-client", "version": "1.0.0"}}'></textarea>
            </div>
            <button onclick="sendJsonRpcRequest()">ğŸ“¤ å‘é€è¯·æ±‚</button>
            <div id="jsonrpcResponse" class="response"></div>
        </div>
        
        <!-- SSEæµå¼è°ƒç”¨æ ‡ç­¾é¡µ -->
        <div id="sse" class="tab-content">
            <h3>ğŸ“¡ SSEæµå¼è°ƒç”¨</h3>
            <div class="preset-selector">
                <label for="ssePreset">é¢„è®¾å‚æ•°:</label>
                <select id="ssePreset" onchange="loadSsePreset()">
                    <option value="">é€‰æ‹©é¢„è®¾å‚æ•°...</option>
                    <option value="user-getById">ğŸ‘¤ è·å–ç”¨æˆ·ä¿¡æ¯ (getUserById)</option>
                    <option value="user-getAll">ğŸ‘¥ è·å–æ‰€æœ‰ç”¨æˆ· (getAllUsers)</option>
                    <option value="user-create">â• åˆ›å»ºç”¨æˆ· (createUser)</option>
                    <option value="user-update">âœï¸ æ›´æ–°ç”¨æˆ· (updateUser)</option>
                    <option value="user-delete">ğŸ—‘ï¸ åˆ é™¤ç”¨æˆ· (deleteUser)</option>
                    <option value="order-getById">ğŸ“¦ è·å–è®¢å•ä¿¡æ¯ (getOrderById)</option>
                    <option value="order-create">ğŸ›’ åˆ›å»ºè®¢å• (createOrder)</option>
                    <option value="order-updateStatus">ğŸ“ æ›´æ–°è®¢å•çŠ¶æ€ (updateOrderStatus)</option>
                    <option value="product-getById">ğŸ›ï¸ è·å–å•†å“ä¿¡æ¯ (getProductById)</option>
                    <option value="product-search">ğŸ” æœç´¢å•†å“ (searchProducts)</option>
                    <option value="product-getByCategory">ğŸ“‚ æŒ‰åˆ†ç±»è·å–å•†å“ (getProductsByCategory)</option>
                    <option value="custom">ğŸ”§ è‡ªå®šä¹‰å‚æ•°</option>
                </select>
                <div id="ssePresetInfo" class="preset-info" style="display: none;">
                    é€‰æ‹©é¢„è®¾å‚æ•°åï¼Œå·¥å…·åç§°å’Œå‚æ•°å°†è‡ªåŠ¨å¡«å……
                </div>
            </div>
            <div class="form-group">
                <label for="sseToolName">å·¥å…·åç§°:</label>
                <input type="text" id="sseToolName" placeholder="service.com.pajk.provider2.UserService.getUserById">
            </div>
            <div class="form-group">
                <label for="sseArguments">å‚æ•° (JSONæ ¼å¼):</label>
                <textarea id="sseArguments" placeholder='{"args": [1]}'></textarea>
            </div>
            <button onclick="startSseStream()" id="sseButton">ğŸŒŠ å¼€å§‹æµå¼è°ƒç”¨</button>
            <button onclick="stopSseStream()" disabled id="sseStopButton">â¹ï¸ åœæ­¢æµå¼è°ƒç”¨</button>
            <div id="sseLog" class="stream-log">
                <div class="stream-entry">ç­‰å¾…å¼€å§‹æµå¼è°ƒç”¨...</div>
            </div>
        </div>
        
        <!-- WebSocketæ ‡ç­¾é¡µ -->
        <div id="websocket" class="tab-content">
            <h3>ğŸ”Œ WebSocketè¿æ¥</h3>
            <div class="form-group">
                <button onclick="connectWebSocket()" id="wsConnectButton">ğŸ”— è¿æ¥WebSocket</button>
                <button onclick="disconnectWebSocket()" disabled id="wsDisconnectButton">âŒ æ–­å¼€è¿æ¥</button>
                <span id="wsStatus">æœªè¿æ¥</span>
            </div>
            <div class="preset-selector">
                <label for="wsPreset">é¢„è®¾æ¶ˆæ¯:</label>
                <select id="wsPreset" onchange="loadWsPreset()">
                    <option value="">é€‰æ‹©é¢„è®¾æ¶ˆæ¯...</option>
                    <option value="initialize">ğŸš€ åˆå§‹åŒ–è¿æ¥</option>
                    <option value="tools-list">ğŸ“‹ è·å–å·¥å…·åˆ—è¡¨</option>
                    <option value="user-getById">ğŸ‘¤ è·å–ç”¨æˆ·ä¿¡æ¯</option>
                    <option value="user-getAll">ğŸ‘¥ è·å–æ‰€æœ‰ç”¨æˆ·</option>
                    <option value="user-create">â• åˆ›å»ºç”¨æˆ·</option>
                    <option value="user-update">âœï¸ æ›´æ–°ç”¨æˆ·</option>
                    <option value="user-delete">ğŸ—‘ï¸ åˆ é™¤ç”¨æˆ·</option>
                    <option value="order-getById">ğŸ“¦ è·å–è®¢å•ä¿¡æ¯</option>
                    <option value="order-create">ğŸ›’ åˆ›å»ºè®¢å•</option>
                    <option value="order-updateStatus">ğŸ“ æ›´æ–°è®¢å•çŠ¶æ€</option>
                    <option value="product-getById">ğŸ›ï¸ è·å–å•†å“ä¿¡æ¯</option>
                    <option value="product-search">ğŸ” æœç´¢å•†å“</option>
                    <option value="product-getByCategory">ğŸ“‚ æŒ‰åˆ†ç±»è·å–å•†å“</option>
                    <option value="ping">ğŸ’“ å¿ƒè·³æ£€æµ‹</option>
                    <option value="custom">ğŸ”§ è‡ªå®šä¹‰æ¶ˆæ¯</option>
                </select>
                <div id="wsPresetInfo" class="preset-info" style="display: none;">
                    é€‰æ‹©é¢„è®¾æ¶ˆæ¯åï¼Œæ¶ˆæ¯å†…å®¹å°†è‡ªåŠ¨å¡«å……
                </div>
            </div>
            <div class="form-group">
                <label for="wsMessage">å‘é€æ¶ˆæ¯ (JSON-RPCæ ¼å¼):</label>
                <textarea id="wsMessage" placeholder='{"jsonrpc": "2.0", "id": "1", "method": "tools/list", "params": {}}'></textarea>
            </div>
            <button onclick="sendWebSocketMessage()" disabled id="wsSendButton">ğŸ“¤ å‘é€æ¶ˆæ¯</button>
            <div id="wsLog" class="stream-log">
                <div class="stream-entry">ç­‰å¾…WebSocketè¿æ¥...</div>
            </div>
        </div>
    </div>

    <script>
        let currentEventSource = null;
        let currentWebSocket = null;
        let sseReceivedLastMessage = false; // è·Ÿè¸ªæ˜¯å¦å·²æ”¶åˆ°æœ€åä¸€æ¡æ¶ˆæ¯
        
        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µ
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }
        
        // åŠ è½½å·¥å…·åˆ—è¡¨
        async function loadTools() {
            try {
                const response = await fetch('/mcp/jsonrpc', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        jsonrpc: '2.0',
                        id: 'tools-list',
                        method: 'tools/list',
                        params: {}
                    })
                });
                
                const result = await response.json();
                displayTools(result.result?.tools || []);
            } catch (error) {
                document.getElementById('toolsList').innerHTML = 
                    `<div class="error">åŠ è½½å·¥å…·åˆ—è¡¨å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        // æ˜¾ç¤ºå·¥å…·åˆ—è¡¨
        function displayTools(tools) {
            const container = document.getElementById('toolsList');
            if (tools.length === 0) {
                container.innerHTML = '<div>æš‚æ— å¯ç”¨å·¥å…·</div>';
                return;
            }
            
            container.innerHTML = tools.map(tool => `
                <div class="tool-card">
                    <div class="tool-name">${tool.name}</div>
                    <div class="tool-description">${tool.description || 'æ— æè¿°'}</div>
                    <div class="tool-meta">
                        æä¾›è€…: ${tool.provider || 'N/A'} | 
                        çŠ¶æ€: <span class="${tool.online ? 'status-online' : 'status-offline'}">
                            ${tool.online ? 'åœ¨çº¿' : 'ç¦»çº¿'}
                        </span> |
                        æµå¼: ${tool.streamable ? 'æ”¯æŒ' : 'ä¸æ”¯æŒ'}
                    </div>
                </div>
            `).join('');
        }
        
        // æ›´æ–°æ–¹æ³•å‚æ•°
        function updateMethodParams() {
            const method = document.getElementById('rpcMethod').value;
            const paramsField = document.getElementById('rpcParams');
            
            const templates = {
                'initialize': '{"protocolVersion": "2024-11-05", "clientInfo": {"name": "test-client", "version": "1.0.0"}}',
                'tools/list': '{}',
                'tools/call': '{"name": "service.com.pajk.provider2.UserService.getUserById", "arguments": {"args": [1]}}',
                'ping': '{}'
            };
            
            paramsField.value = templates[method] || '{}';
        }
        
        // åŠ è½½SSEé¢„è®¾å‚æ•°
        function loadSsePreset() {
            const preset = document.getElementById('ssePreset').value;
            const toolNameField = document.getElementById('sseToolName');
            const argumentsField = document.getElementById('sseArguments');
            const presetInfo = document.getElementById('ssePresetInfo');
            
            const presets = {
                'user-getById': {
                    toolName: 'service.com.pajk.provider2.UserService.getUserById',
                    arguments: '{"args": [1]}',
                    description: 'æ ¹æ®ç”¨æˆ·IDè·å–ç”¨æˆ·ä¿¡æ¯'
                },
                'user-getAll': {
                    toolName: 'service.com.pajk.provider2.UserService.getAllUsers',
                    arguments: '{"args": []}',
                    description: 'è·å–æ‰€æœ‰ç”¨æˆ·åˆ—è¡¨'
                },
                'user-create': {
                    toolName: 'service.com.pajk.provider2.UserService.createUser',
                    arguments: '{"args": [{"name": "å¼ ä¸‰", "email": "zhangsan@example.com", "age": 25}]}',
                    description: 'åˆ›å»ºæ–°ç”¨æˆ·'
                },
                'user-update': {
                    toolName: 'service.com.pajk.provider2.UserService.updateUser',
                    arguments: '{"args": [{"id": 1, "username": "alice_updated", "email": "alice_updated@example.com", "phone": "13800138001", "realName": "Alice Wang Updated", "age": 26, "gender": "F", "status": "ACTIVE"}]}',
                    description: 'æ›´æ–°ç”¨æˆ·ä¿¡æ¯'
                },
                'user-delete': {
                    toolName: 'service.com.pajk.provider2.UserService.deleteUser',
                    arguments: '{"args": [1]}',
                    description: 'åˆ é™¤ç”¨æˆ·'
                },
                'order-getById': {
                    toolName: 'service.com.pajk.provider2.OrderService.getOrderById',
                    arguments: '{"args": ["ORDBB8E7DF1"]}',
                    description: 'æ ¹æ®è®¢å•IDè·å–è®¢å•ä¿¡æ¯'
                },
                'order-create': {
                    toolName: 'service.com.pajk.provider2.OrderService.createOrder',
                    arguments: '{"args": [{"userId": 1, "productId": 1, "quantity": 2, "totalAmount": 199.98}]}',
                    description: 'åˆ›å»ºæ–°è®¢å•'
                },
                'order-updateStatus': {
                    toolName: 'service.com.pajk.provider2.OrderService.updateOrderStatus',
                    arguments: '{"args": ["ORDBB8E7DF1", "SHIPPED"]}',
                    description: 'æ›´æ–°è®¢å•çŠ¶æ€'
                },
                'product-getById': {
                    toolName: 'service.com.pajk.provider2.ProductService.getProductById',
                    arguments: '{"args": [1]}',
                    description: 'æ ¹æ®å•†å“IDè·å–å•†å“ä¿¡æ¯'
                },
                'product-search': {
                    toolName: 'service.com.pajk.provider2.ProductService.searchProducts',
                    arguments: '{"args": ["iPhone"]}',
                    description: 'æœç´¢å•†å“'
                },
                'product-getByCategory': {
                    toolName: 'service.com.pajk.provider2.ProductService.getProductsByCategory',
                    arguments: '{"args": ["æ‰‹æœºæ•°ç "]}',
                    description: 'æŒ‰åˆ†ç±»è·å–å•†å“'
                }
            };
            
            if (preset && presets[preset]) {
                toolNameField.value = presets[preset].toolName;
                argumentsField.value = presets[preset].arguments;
                presetInfo.textContent = presets[preset].description;
                presetInfo.style.display = 'block';
            } else if (preset === 'custom') {
                toolNameField.value = '';
                argumentsField.value = '';
                presetInfo.style.display = 'none';
            } else {
                presetInfo.style.display = 'none';
            }
        }
        
        // åŠ è½½WebSocketé¢„è®¾æ¶ˆæ¯
        function loadWsPreset() {
            const preset = document.getElementById('wsPreset').value;
            const messageField = document.getElementById('wsMessage');
            const presetInfo = document.getElementById('wsPresetInfo');
            
            const presets = {
                'initialize': {
                    message: '{"jsonrpc": "2.0", "id": "init-1", "method": "initialize", "params": {"protocolVersion": "2024-11-05", "clientInfo": {"name": "test-client", "version": "1.0.0"}}}',
                    description: 'åˆå§‹åŒ–MCPè¿æ¥ï¼Œå»ºç«‹å®¢æˆ·ç«¯ä¼šè¯'
                },
                'tools-list': {
                    message: '{"jsonrpc": "2.0", "id": "tools-list-1", "method": "tools/list", "params": {}}',
                    description: 'è·å–æ‰€æœ‰å¯ç”¨çš„MCPå·¥å…·åˆ—è¡¨'
                },
                'user-getById': {
                    message: '{"jsonrpc": "2.0", "id": "user-1", "method": "tools/call", "params": {"name": "service.com.pajk.provider2.UserService.getUserById", "arguments": {"args": [1]}}}',
                    description: 'æ ¹æ®ç”¨æˆ·IDè·å–ç”¨æˆ·ä¿¡æ¯'
                },
                'user-getAll': {
                    message: '{"jsonrpc": "2.0", "id": "user-all-1", "method": "tools/call", "params": {"name": "service.com.pajk.provider2.UserService.getAllUsers", "arguments": {"args": []}}}',
                    description: 'è·å–æ‰€æœ‰ç”¨æˆ·åˆ—è¡¨'
                },
                'user-create': {
                    message: '{"jsonrpc": "2.0", "id": "user-create-1", "method": "tools/call", "params": {"name": "service.com.pajk.provider2.UserService.createUser", "arguments": {"args": [{"name": "å¼ ä¸‰", "email": "zhangsan@example.com", "age": 25}]}}}',
                    description: 'åˆ›å»ºæ–°ç”¨æˆ·'
                },
                'user-update': {
                    message: '{"jsonrpc": "2.0", "id": "user-update-1", "method": "tools/call", "params": {"name": "service.com.pajk.provider2.UserService.updateUser", "arguments": {"args": [{"id": 1, "username": "alice_updated", "email": "alice_updated@example.com", "phone": "13800138001", "realName": "Alice Wang Updated", "age": 26, "gender": "F", "status": "ACTIVE"}]}}}',
                    description: 'æ›´æ–°ç”¨æˆ·ä¿¡æ¯'
                },
                'user-delete': {
                    message: '{"jsonrpc": "2.0", "id": "user-delete-1", "method": "tools/call", "params": {"name": "service.com.pajk.provider2.UserService.deleteUser", "arguments": {"args": [1]}}}',
                    description: 'åˆ é™¤ç”¨æˆ·'
                },
                'order-getById': {
                    message: '{"jsonrpc": "2.0", "id": "order-1", "method": "tools/call", "params": {"name": "service.com.pajk.provider2.OrderService.getOrderById", "arguments": {"args": ["ORDBB8E7DF1"]}}}',
                    description: 'æ ¹æ®è®¢å•IDè·å–è®¢å•ä¿¡æ¯'
                },
                'order-create': {
                    message: '{"jsonrpc": "2.0", "id": "order-create-1", "method": "tools/call", "params": {"name": "service.com.pajk.provider2.OrderService.createOrder", "arguments": {"args": [{"userId": 1, "productId": 1, "quantity": 2, "totalAmount": 199.98}]}}}',
                    description: 'åˆ›å»ºæ–°è®¢å•'
                },
                'order-updateStatus': {
                    message: '{"jsonrpc": "2.0", "id": "order-update-1", "method": "tools/call", "params": {"name": "service.com.pajk.provider2.OrderService.updateOrderStatus", "arguments": {"args": ["ORDBB8E7DF1", "SHIPPED"]}}}',
                    description: 'æ›´æ–°è®¢å•çŠ¶æ€'
                },
                'product-getById': {
                    message: '{"jsonrpc": "2.0", "id": "product-1", "method": "tools/call", "params": {"name": "service.com.pajk.provider2.ProductService.getProductById", "arguments": {"args": [1]}}}',
                    description: 'æ ¹æ®å•†å“IDè·å–å•†å“ä¿¡æ¯'
                },
                'product-search': {
                    message: '{"jsonrpc": "2.0", "id": "product-search-1", "method": "tools/call", "params": {"name": "service.com.pajk.provider2.ProductService.searchProducts", "arguments": {"args": ["iPhone"]}}}',
                    description: 'æœç´¢å•†å“'
                },
                'product-getByCategory': {
                    message: '{"jsonrpc": "2.0", "id": "product-category-1", "method": "tools/call", "params": {"name": "service.com.pajk.provider2.ProductService.getProductsByCategory", "arguments": {"args": ["æ‰‹æœºæ•°ç "]}}}',
                    description: 'æŒ‰åˆ†ç±»è·å–å•†å“'
                },
                'ping': {
                    message: '{"jsonrpc": "2.0", "id": "ping-1", "method": "ping", "params": {}}',
                    description: 'å‘é€å¿ƒè·³æ£€æµ‹ï¼Œæµ‹è¯•è¿æ¥çŠ¶æ€'
                }
            };
            
            if (preset && presets[preset]) {
                messageField.value = presets[preset].message;
                presetInfo.textContent = presets[preset].description;
                presetInfo.style.display = 'block';
            } else if (preset === 'custom') {
                messageField.value = '';
                presetInfo.style.display = 'none';
            } else {
                presetInfo.style.display = 'none';
            }
        }
        
        // å‘é€JSON-RPCè¯·æ±‚
        async function sendJsonRpcRequest() {
            const method = document.getElementById('rpcMethod').value;
            const paramsText = document.getElementById('rpcParams').value;
            const responseDiv = document.getElementById('jsonrpcResponse');
            
            try {
                const params = paramsText ? JSON.parse(paramsText) : {};
                const request = {
                    jsonrpc: '2.0',
                    id: Date.now().toString(),
                    method: method,
                    params: params
                };
                
                responseDiv.innerHTML = 'å‘é€è¯·æ±‚ä¸­...';
                responseDiv.className = 'response';
                
                const response = await fetch('/mcp/jsonrpc', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(request)
                });
                
                const result = await response.json();
                responseDiv.innerHTML = JSON.stringify(result, null, 2);
                responseDiv.className = result.error ? 'response error' : 'response success';
                
            } catch (error) {
                responseDiv.innerHTML = `é”™è¯¯: ${error.message}`;
                responseDiv.className = 'response error';
            }
        }
        
        // å¼€å§‹SSEæµå¼è°ƒç”¨
        async function startSseStream() {
            // é‡ç½®æ ‡å¿—
            sseReceivedLastMessage = false;
            
            const toolName = document.getElementById('sseToolName').value;
            const argumentsText = document.getElementById('sseArguments').value;
            const logDiv = document.getElementById('sseLog');
            
            if (!toolName) {
                alert('è¯·è¾“å…¥å·¥å…·åç§°');
                return;
            }
            
            try {
                const arguments_ = argumentsText ? JSON.parse(argumentsText) : {};
                
                logDiv.innerHTML = '<div class="stream-entry">æ­£åœ¨åˆ›å»ºæµå¼è°ƒç”¨...</div>';
                
                // é¦–å…ˆåˆ›å»ºæµå¼è°ƒç”¨
                const response = await fetch('/mcp/jsonrpc', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        jsonrpc: '2.0',
                        id: Date.now().toString(),
                        method: 'tools/call',
                        params: {
                            name: toolName,
                            arguments: arguments_,
                            stream: true
                        }
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯: ${response.status} ${response.statusText}`);
                }
                
                const result = await response.json();
                addStreamLog(logDiv, 'info', `æœåŠ¡å™¨å“åº”: ${JSON.stringify(result, null, 2)}`);
                
                if (result.result && result.result.streamId) {
                    // å¼€å§‹SSEç›‘å¬
                    const streamId = result.result.streamId;
                    currentEventSource = new EventSource(`/mcp/stream/${streamId}`);
                    
                    logDiv.innerHTML = `<div class="stream-entry">å¼€å§‹ç›‘å¬æµå¼æ•°æ® (Stream ID: ${streamId})...</div>`;
                    
                    // ç›‘å¬openäº‹ä»¶
                    currentEventSource.onopen = function(event) {
                        addStreamLog(logDiv, 'info', 'SSEè¿æ¥å·²å»ºç«‹');
                    };
                    
                    // ç›‘å¬é»˜è®¤æ¶ˆæ¯äº‹ä»¶
                    currentEventSource.onmessage = function(event) {
                        try {
                            const data = JSON.parse(event.data);
                            addStreamLog(logDiv, 'data', data);
                            
                            // å¦‚æœæ˜¯æœ€åä¸€æ¡æ¶ˆæ¯ï¼Œè®¾ç½®æ ‡å¿—å¹¶è‡ªåŠ¨å…³é—­è¿æ¥
                            if (data.isLast) {
                                sseReceivedLastMessage = true;
                                setTimeout(() => stopSseStream(), 1000);
                            }
                        } catch (e) {
                            addStreamLog(logDiv, 'error', `è§£ææ•°æ®å¤±è´¥: ${e.message}`);
                        }
                    };
                    
                    // ç›‘å¬è‡ªå®šä¹‰"data"äº‹ä»¶
                    currentEventSource.addEventListener('data', function(event) {
                        try {
                            const data = JSON.parse(event.data);
                            addStreamLog(logDiv, 'data', data);
                            
                            // å¦‚æœæ˜¯æœ€åä¸€æ¡æ¶ˆæ¯ï¼Œè®¾ç½®æ ‡å¿—å¹¶è‡ªåŠ¨å…³é—­è¿æ¥
                            if (data.isLast) {
                                sseReceivedLastMessage = true;
                                setTimeout(() => stopSseStream(), 1000);
                            }
                        } catch (e) {
                            addStreamLog(logDiv, 'error', `è§£ææ•°æ®å¤±è´¥: ${e.message}`);
                        }
                    });
                    
                    // ç›‘å¬è‡ªå®šä¹‰"error"äº‹ä»¶
                    currentEventSource.addEventListener('error', function(event) {
                        try {
                            const data = JSON.parse(event.data);
                            addStreamLog(logDiv, 'error', data);
                        } catch (e) {
                            // äº‹ä»¶å¯èƒ½æ²¡æœ‰data
                        }
                    });
                    
                    // ç›‘å¬è¿æ¥é”™è¯¯
                    currentEventSource.onerror = function(event) {
                        // å¦‚æœå·²ç»æ”¶åˆ°æœ€åä¸€æ¡æ¶ˆæ¯ï¼Œè¿™æ˜¯æ­£å¸¸å…³é—­
                        if (sseReceivedLastMessage) {
                            addStreamLog(logDiv, 'info', 'âœ… SSEæ•°æ®ä¼ è¾“å®Œæˆï¼Œè¿æ¥å·²å…³é—­');
                        } else if (currentEventSource.readyState === EventSource.CLOSED) {
                            // è¿æ¥å·²å…³é—­ä½†æ²¡æœ‰æ”¶åˆ°æœ€åä¸€æ¡æ¶ˆæ¯ï¼Œå¯èƒ½æ˜¯å¼‚å¸¸
                            addStreamLog(logDiv, 'error', 'âš ï¸ SSEè¿æ¥æ„å¤–å…³é—­ï¼ˆæœªæ”¶åˆ°å®Œæ•´æ•°æ®ï¼‰');
                        } else {
                            // å…¶ä»–é”™è¯¯æƒ…å†µ
                            addStreamLog(logDiv, 'error', 'âŒ SSEè¿æ¥é”™è¯¯æˆ–æ–­å¼€');
                        }
                        // ä¸è¦ç«‹å³åœæ­¢ï¼Œè®©ç”¨æˆ·å¯ä»¥çœ‹åˆ°æ¶ˆæ¯
                        setTimeout(() => {
                            if (currentEventSource && currentEventSource.readyState !== EventSource.OPEN) {
                                stopSseStream();
                            }
                        }, 500);
                    };
                    
                    document.getElementById('sseButton').disabled = true;
                    document.getElementById('sseStopButton').disabled = false;
                } else {
                    logDiv.innerHTML = `<div class="stream-entry stream-error">åˆ›å»ºæµå¼è°ƒç”¨å¤±è´¥: ${JSON.stringify(result)}</div>`;
                }
                
            } catch (error) {
                logDiv.innerHTML = `<div class="stream-entry stream-error">é”™è¯¯: ${error.message}</div>`;
            }
        }
        
        // åœæ­¢SSEæµå¼è°ƒç”¨
        function stopSseStream() {
            if (currentEventSource) {
                currentEventSource.close();
                currentEventSource = null;
            }
            
            // é‡ç½®æ ‡å¿—
            sseReceivedLastMessage = false;
            
            document.getElementById('sseButton').disabled = false;
            document.getElementById('sseStopButton').disabled = true;
            
            const logDiv = document.getElementById('sseLog');
            addStreamLog(logDiv, 'info', 'â¹ï¸ æµå¼è°ƒç”¨å·²åœæ­¢');
        }
        
        // æ·»åŠ æµå¼æ—¥å¿—
        function addStreamLog(logDiv, type, data) {
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'stream-entry';
            
            let content = `<span class="stream-timestamp">[${timestamp}]</span> `;
            
            if (type === 'data') {
                content += `<span class="stream-data">ğŸ“¦ æ•°æ®: ${JSON.stringify(data, null, 2)}</span>`;
            } else if (type === 'error') {
                content += `<span class="stream-error">âŒ é”™è¯¯: ${typeof data === 'string' ? data : JSON.stringify(data)}</span>`;
            } else if (type === 'info') {
                content += `<span style="color: #17a2b8;">â„¹ï¸ ${typeof data === 'string' ? data : JSON.stringify(data, null, 2)}</span>`;
            } else {
                content += data;
            }
            
            entry.innerHTML = content;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        // è¿æ¥WebSocket
        function connectWebSocket() {
            const wsUrl = `ws://${window.location.host}/mcp/ws`;
            const logDiv = document.getElementById('wsLog');
            
            currentWebSocket = new WebSocket(wsUrl);
            
            currentWebSocket.onopen = function(event) {
                addWebSocketLog(logDiv, 'info', 'WebSocketè¿æ¥å·²å»ºç«‹');
                document.getElementById('wsConnectButton').disabled = true;
                document.getElementById('wsDisconnectButton').disabled = false;
                document.getElementById('wsSendButton').disabled = false;
                document.getElementById('wsStatus').textContent = 'å·²è¿æ¥';
                document.getElementById('wsStatus').style.color = '#28a745';
            };
            
            currentWebSocket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                addWebSocketLog(logDiv, 'receive', data);
            };
            
            currentWebSocket.onclose = function(event) {
                addWebSocketLog(logDiv, 'info', 'WebSocketè¿æ¥å·²å…³é—­');
                disconnectWebSocket();
            };
            
            currentWebSocket.onerror = function(event) {
                addWebSocketLog(logDiv, 'error', 'WebSocketè¿æ¥é”™è¯¯');
            };
        }
        
        // æ–­å¼€WebSocket
        function disconnectWebSocket() {
            if (currentWebSocket) {
                currentWebSocket.close();
                currentWebSocket = null;
            }
            
            document.getElementById('wsConnectButton').disabled = false;
            document.getElementById('wsDisconnectButton').disabled = true;
            document.getElementById('wsSendButton').disabled = true;
            document.getElementById('wsStatus').textContent = 'æœªè¿æ¥';
            document.getElementById('wsStatus').style.color = '#dc3545';
        }
        
        // å‘é€WebSocketæ¶ˆæ¯
        function sendWebSocketMessage() {
            const messageText = document.getElementById('wsMessage').value;
            const logDiv = document.getElementById('wsLog');
            
            if (!currentWebSocket || currentWebSocket.readyState !== WebSocket.OPEN) {
                alert('WebSocketæœªè¿æ¥');
                return;
            }
            
            try {
                const message = JSON.parse(messageText);
                currentWebSocket.send(JSON.stringify(message));
                addWebSocketLog(logDiv, 'send', message);
            } catch (error) {
                addWebSocketLog(logDiv, 'error', `å‘é€æ¶ˆæ¯å¤±è´¥: ${error.message}`);
            }
        }
        
        // æ·»åŠ WebSocketæ—¥å¿—
        function addWebSocketLog(logDiv, type, data) {
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'stream-entry';
            
            let content = `<span class="stream-timestamp">[${timestamp}]</span> `;
            
            if (type === 'send') {
                content += `<span style="color: #17a2b8;">å‘é€: ${JSON.stringify(data)}</span>`;
            } else if (type === 'receive') {
                content += `<span class="stream-data">æ¥æ”¶: ${JSON.stringify(data)}</span>`;
            } else if (type === 'error') {
                content += `<span class="stream-error">é”™è¯¯: ${data}</span>`;
            } else {
                content += data;
            }
            
            entry.innerHTML = content;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨åŠ è½½å·¥å…·åˆ—è¡¨
        window.onload = function() {
            loadTools();
        };
        
        // é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº
        window.onbeforeunload = function() {
            stopSseStream();
            disconnectWebSocket();
        };
    </script>
</body>
</html>

